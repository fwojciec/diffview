{"id":"diffview-05v","title":"Review and refactor bubbletea/viewer.go and test suite","description":"## Problem\nThe bubbletea/viewer.go implementation and its 2000+ line test suite have accumulated cruft through many iterations. The code needs review and streamlining.\n\n## Scope\n\n### 1. Remove outdated tests\nIdentify and remove tests that:\n- Test behavior that no longer exists\n- Are redundant with other tests\n- Test implementation details rather than behavior\n\n### 2. Refactor implementation\n- Remove backwards compatibility code\n- Streamline for current solution\n- Factor into well-organized functions\n- Eliminate dead code paths\n\n### 3. Audit and streamline test suite\n- Create inventory of all tests and their assertions (temporary document)\n- Identify overlapping coverage\n- Develop strategy for maximum utility with minimal maintenance burden\n- Bias toward behavioral tests over implementation tests\n- Ensure high-quality assertions\n\n## Entrypoints\n- `bubbletea/viewer.go`: Main implementation (~870 lines)\n- `bubbletea/viewer_test.go`: Test suite (~2000+ lines)\n\n## Deliverables\n- [ ] Test inventory document (temporary, for planning)\n- [ ] Cleaned implementation with improved factoring\n- [ ] Streamlined test suite with clear behavioral coverage\n- [ ] make validate passes\n\n## Notes\nThis is a refactoring task - no new features. Focus on clarity, maintainability, and test quality.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T22:57:52.061798-08:00","updated_at":"2025-12-25T23:13:11.050827-08:00","closed_at":"2025-12-25T23:13:11.050827-08:00","close_reason":"Closed"}
{"id":"diffview-0o8","title":"Context cancellation support","description":"## Problem\nThe Viewer.View method accepts a context parameter but doesn't use it. This means there's no way to cancel a running viewer externally.\n\n## Entrypoints\n- bubbletea/viewer.go:93 (View method)\n\n## Solution\nAdd tea.WithContext(ctx) to the program options:\n```go\np := tea.NewProgram(m,\n    tea.WithAltScreen(),\n    tea.WithMouseCellMotion(),\n    tea.WithContext(ctx),\n)\n```\n\n## Validation\n- [ ] Context cancellation terminates the viewer\n- [ ] Test covers cancellation behavior\n- [ ] make validate passes","notes":"COMPLETED: Context cancellation support\n- Added tea.WithContext(ctx) to program options\n- Added ViewerOption functional options pattern for testing\n- Test verifies viewer exits when context is cancelled\n\nKEY_DECISIONS:\n- Added WithProgramOptions() for injecting custom IO in tests\n- This enables testing without requiring a TTY","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-23T20:35:25.013463-08:00","updated_at":"2025-12-23T20:55:39.68024-08:00","closed_at":"2025-12-23T20:55:39.680244-08:00","dependencies":[{"issue_id":"diffview-0o8","depends_on_id":"diffview-z57","type":"blocks","created_at":"2025-12-23T20:35:32.158933-08:00","created_by":"daemon"}]}
{"id":"diffview-0ti","title":"Create overlay syntax theme for diff backgrounds","description":"## Problem\nStandard chroma themes have background colors that conflict with diff backgrounds.\n\n## Implementation\nCreate custom chroma style with no backgrounds so diff backgrounds show through:\n\n```go\noverlayStyle := chroma.MustNewStyle(\"overlay\", chroma.StyleEntries{\n    chroma.Background:   \"noinherit\", // Critical: no background\n    chroma.Keyword:      \"bold #ff79c6\",\n    chroma.String:       \"#f1fa8c\",\n    // ... etc\n})\n```\n\nAlso update diff background colors to be very dark/desaturated:\n- MinusBackground: #3f0001 (very dark red)\n- PlusBackground: #004000 (very dark green)\n\n## Validation\n- [ ] Syntax colors readable on all three backgrounds (added/deleted/context)\n- [ ] No background color bleeding\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T20:16:01.541751-08:00","updated_at":"2025-12-25T13:01:48.615644-08:00","closed_at":"2025-12-25T13:01:48.615644-08:00","close_reason":"Implemented darker diff backgrounds for syntax overlay","dependencies":[{"issue_id":"diffview-0ti","depends_on_id":"diffview-tsg","type":"blocks","created_at":"2025-12-24T20:16:09.368051-08:00","created_by":"daemon"}]}
{"id":"diffview-120","title":"Add commit message extraction to GitRunner","description":"## Problem\n`git.Runner.Show()` currently uses `--format=` to exclude commit message. We need message for classification.\n\n## Entrypoints\n- git/runner.go\n- diffview.go (GitRunner interface)\n\n## Changes\n1. Add `Message()` method to GitRunner interface:\n```go\ntype GitRunner interface {\n    Log(ctx context.Context, repoPath string, limit int) ([]string, error)\n    Show(ctx context.Context, repoPath string, hash string) (string, error)\n    Message(ctx context.Context, repoPath string, hash string) (string, error) // NEW\n}\n```\n\n2. Implement in git/runner.go:\n```go\nfunc (r *Runner) Message(ctx context.Context, repoPath, hash string) (string, error) {\n    args := []string{\"-C\", repoPath, \"show\", \"--format=%B\", \"-s\", hash}\n    // ...\n}\n```\n\n3. Add mock in mock/git.go\n\n## Validation\n- [ ] Can extract commit message for any hash\n- [ ] Mock updated for testing\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T21:33:12.723612-08:00","updated_at":"2025-12-26T22:17:39.663328-08:00","closed_at":"2025-12-26T22:17:39.663328-08:00","close_reason":"Implemented as part of epic diffview-6f7","dependencies":[{"issue_id":"diffview-120","depends_on_id":"diffview-ni2","type":"blocks","created_at":"2025-12-26T21:34:22.642794-08:00","created_by":"daemon"}]}
{"id":"diffview-1ib","title":"Runtime git context enrichment for piped diffs","description":"## Problem\nWhen a diff is piped to diffview, we lose git context (branch, commits). But if the user is in a git repo with good hygiene (committed changes), we could enrich the classification.\n\n## Approach\n1. Receive piped diff\n2. If in git repo: query branch, merge-base, commits\n3. Generate expected diff from commits\n4. Compare piped diff to expected:\n   - Match → full context enrichment\n   - Superset → uncommitted changes, warn user\n   - No match → foreign diff, classify without context\n\n## Rewards good hygiene\n- Committed work gets commit messages in classification\n- Uncommitted changes get a nudge to commit first\n- Random patch files still work, just no enrichment\n\n## Validation\n- [ ] Piped diff from committed branch gets commit context\n- [ ] Uncommitted changes detected and warned\n- [ ] Foreign diffs classified without errors","status":"open","priority":3,"issue_type":"feature","created_at":"2025-12-27T10:51:16.849565-08:00","created_by":"filip","updated_at":"2025-12-27T10:51:16.849565-08:00","dependencies":[{"issue_id":"diffview-1ib","depends_on_id":"diffview-mle","type":"blocks","created_at":"2025-12-27T10:51:32.958098-08:00","created_by":"daemon"}]}
{"id":"diffview-1mu","title":"Add word-level diff highlighting within changed lines","description":"## Problem\nWhen a line changes slightly, the entire line is highlighted. Users must manually compare old/new lines to spot the actual change. Critical for reviewing small edits buried in long lines.\n\n## Solution\nHighlight the specific words/characters that changed within modified lines:\n```\n-function calculate(x, y) {\n+function calculate(x, y, z) {\n                       ^^^  ← these chars get extra highlight\n```\n\n## Implementation\n1. During rendering, detect consecutive delete+add line pairs\n2. Run character or word-level diff algorithm (Myers or similar)\n3. Apply layered styling: base deleted/added style + brighter foreground for changed segments\n4. Consider a new package for word diffing logic\n\n## Complexity\nHigh - requires diffing algorithm for inline changes. Consider:\n- github.com/sergi/go-diff for diff algorithm\n- Word-based vs character-based granularity\n- Performance for large files\n\n## Entrypoints\n- bubbletea/viewer.go:254-268 (line rendering)\n- New package: worddiff/ or inline diff logic\n\n## Validation\n- [ ] Changed segments within lines are visually distinct\n- [ ] Works for both additions and deletions\n- [ ] Handles multiple changes per line\n- [ ] Performance acceptable for large diffs\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-23T23:51:20.633449-08:00","updated_at":"2025-12-24T09:38:53.473574-08:00","closed_at":"2025-12-24T09:38:53.47358-08:00"}
{"id":"diffview-1ur","title":"Style file header stats with semantic colors","description":"## Problem\nThe enhanced file header shows change stats (+N -M) but they're monochrome, blending with the filename. This misses an opportunity for at-a-glance visual scanning.\n\n## Current\n```\n── handler.go ─────────────────────────────── +15 -8 ──\n```\nAll same color - stats don't pop.\n\n## Proposed Improvements\n\n### 1. Semantic stat colors\n- `+N` in green (matches added line color)\n- `-M` in red (matches deleted line color)\n\n### 2. Visual hierarchy\n- Dim the box-drawing fill chars (─)\n- Keep filename prominent/bright\n- Stats styled distinctly\n\n### 3. Optional enhancements\n- Subtle spacing after header before first hunk\n- Consider badge-style stats with background color\n- Bold filename, regular weight for decorative elements\n\n## Entrypoints\n- bubbletea/viewer.go:456-477 (renderDiff file header section)\n- May need new style entries in diffview.Styles (StatAdded, StatDeleted)\n\n## Validation\n- [ ] +N shows in green/added color\n- [ ] -M shows in red/deleted color  \n- [ ] Fill chars (─) are visually subdued\n- [ ] Filename remains prominent\n- [ ] make validate passes","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-24T12:30:02.188654-08:00","updated_at":"2025-12-24T15:14:09.254565-08:00","closed_at":"2025-12-24T15:14:09.254565-08:00","close_reason":"Pausing: visual direction shifting from full-background colors to gutter-mark-based minimal UI. Will revisit accessibility themes once new primitives are in place."}
{"id":"diffview-1y9","title":"Add background colors for added/deleted lines","description":"## Problem\nCurrently only text color changes for added/deleted lines. This makes scanning large diffs slow - the eye must read each line to notice changes rather than catching blocks of color.\n\n## Solution\nAdd subtle background tints to entire lines:\n- Added lines: subtle green background (e.g., #2d3f2d on dark theme)\n- Deleted lines: subtle red background (e.g., #3f2d2d on dark theme)\n\nLike GitHub/GitLab diff views where changed lines have colored backgrounds.\n\n## Implementation\n- Update ColorPair usage in styles to include backgrounds for Added/Deleted\n- In renderDiffWithPositions(), pad lines to terminal width so background extends full width\n- May need to pass terminal width to renderer or use a fixed large width\n\n## Entrypoints\n- lipgloss/theme.go:25 (DarkTheme - add backgrounds)\n- lipgloss/theme.go:49 (LightTheme - add backgrounds)  \n- bubbletea/viewer.go:254-268 (line rendering - ensure full-width)\n\n## Validation\n- [ ] Added lines have subtle green background extending full width\n- [ ] Deleted lines have subtle red background extending full width\n- [ ] Context lines have no background (or terminal default)\n- [ ] Colors work well on both dark and light themes\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-23T23:51:10.161456-08:00","updated_at":"2025-12-24T08:12:49.132207-08:00","closed_at":"2025-12-24T08:12:49.132215-08:00"}
{"id":"diffview-206","title":"Research: collapsible sections UI primitive","description":"## Problem\nThe future 'intelligence layer' will need to show summaries that expand to details. Before implementing, we need to understand:\n\n1. **What to collapse** - Function-level? File-level? Semantic groupings?\n2. **Signal vs noise** - How do we determine what's 'important' vs 'trivial'?\n3. **UI mechanics** - How does expand/collapse work in a TUI? Keybindings? Visual indicators?\n4. **State management** - Remember what's expanded across navigation?\n\n## Questions to Answer\n- What do existing TUI tools do? (lazygit, tig, etc.)\n- What heuristics could identify 'trivial' changes (imports, formatting)?\n- How would this interact with the future LLM-powered intelligence layer?\n- What's the minimum viable version we could ship to learn from?\n\n## Deliverables\n- [ ] Document findings\n- [ ] Recommend approach with trade-offs\n- [ ] Create implementation issues if clear path emerges\n\n## Context\nThis is foundational infrastructure for the 'feedback interface' vision - progressive disclosure where reviewers see summaries first, details on demand.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-24T15:26:43.611821-08:00","updated_at":"2025-12-26T12:00:01.360341-08:00","closed_at":"2025-12-26T12:00:01.360341-08:00","close_reason":"Closing to reframe - need more research into UI primitives but want better task framing first"}
{"id":"diffview-26d","title":"Epic: Unified Theme System","description":"## Overview\nImplement a unified theming system with an 18-color Palette as single source of truth.\n\n## Design\nSee docs/plans/2025-12-25-unified-theme-system-design.md\n\n## Goals\n- Single Palette type generates all colors (diff, syntax, UI)\n- Follows delta's layer superimposition pattern\n- TestTheme() for stable test colors\n- Remove all hardcoded colors\n\n## Child Tasks\n- Add Palette type to root package\n- Implement palette-based theme in lipgloss/\n- Add StyleFromPalette to chroma/\n- Update viewer to use Theme\n- Wire theme in cmd/diffview/main.go\n\n## Unblocks\n- diffview-imr: Integrate syntax highlighting with rendering","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-25T13:52:54.502197-08:00","updated_at":"2025-12-25T16:20:25.873542-08:00","closed_at":"2025-12-25T16:20:25.873542-08:00","close_reason":"Closed"}
{"id":"diffview-2vk","title":"Remove worddiff package and sergi/go-diff dependency","description":"## Task\nClean up by removing the old implementation and unused dependency.\n\n## Entrypoints\n- worddiff/ (delete directory)\n- go.mod\n\n## Implementation\n1. Delete worddiff/ directory entirely\n2. Run go mod tidy to remove sergi/go-diff\n3. Verify build and tests still pass\n\n## Validation\n- [ ] worddiff/ directory deleted\n- [ ] sergi/go-diff not in go.mod\n- [ ] go build ./... succeeds\n- [ ] go test ./... passes\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:07:21.303975-08:00","updated_at":"2025-12-26T09:32:46.354097-08:00","closed_at":"2025-12-26T09:32:46.354097-08:00","close_reason":"Closed","dependencies":[{"issue_id":"diffview-2vk","depends_on_id":"diffview-n5y","type":"blocks","created_at":"2025-12-26T00:07:29.901804-08:00","created_by":"daemon"}]}
{"id":"diffview-32w","title":"Add timeout handling to classify command","description":"## Problem\nThe classify command hung indefinitely on case 84/96. No timeout or retry logic exists for API calls.\n\n## Observed Behavior\n- Classifier processes 83 cases successfully\n- Case 84 causes indefinite hang (API call never returns)\n- No way to detect or recover from hung requests\n\n## Solution\nAdd timeout and retry logic:\n1. Per-case timeout (e.g., 60 seconds)\n2. Retry with exponential backoff (3 attempts)\n3. Skip case after max retries, log warning\n4. Consider --timeout flag for user control\n\n## Entrypoints\n- cmd/diffstory/main.go: ClassifyRunner.Run()\n- gemini/classifier.go: Classify()\n\n## Validation\n- [ ] Hung API calls timeout after configured duration\n- [ ] Failed cases are retried\n- [ ] Unrecoverable cases are skipped with warning\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-27T13:15:35.040196-08:00","created_by":"filip","updated_at":"2025-12-27T13:33:54.192581-08:00","closed_at":"2025-12-27T13:33:54.192581-08:00","close_reason":"Closed"}
{"id":"diffview-3xh","title":"Add vertical whitespace between hunks","description":"## Problem\nHunks run together with no visual separation, creating a dense wall of code that's hard to parse. The eye has no resting points.\n\n## Solution\nAdd 1 empty line of vertical whitespace between hunks within a file. This creates natural breathing room and visual grouping without changing any content.\n\n## Design Direction\nPart of the 'less is more' visual refresh - using whitespace as information to guide attention rather than adding more visual elements.\n\n## Entrypoints\n- bubbletea/viewer.go (renderDiff or equivalent)\n\n## Validation\n- [ ] Visual gap appears between consecutive hunks\n- [ ] No gap before first hunk or after last hunk in a file\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T15:17:21.369002-08:00","updated_at":"2025-12-25T21:03:37.615748-08:00","closed_at":"2025-12-25T21:03:37.615748-08:00","close_reason":"Design direction changed - will revisit after GitHub-inspired theme"}
{"id":"diffview-3zd","title":"Add collect subcommand to diffstory","description":"## Problem\nNeed to extract diffs from git history for building eval dataset. Extraction only - analysis is run separately.\n\n## Entrypoints\n- Add to `cmd/diffstory/main.go`\n\n## Usage\n```bash\ndiffstory collect . --limit=50\ndiffstory collect ../locdoc --limit=20\n```\n\n## Implementation\n- Shell out to `git log` to get commit hashes\n- Shell out to `git show \u003chash\u003e` to get diffs\n- Annotate hunks with IDs\n- Write to eval/cases/ as JSONL (input format, no analysis yet)\n\n## Validation\n- [ ] Extracts diffs from git history\n- [ ] Respects --limit flag\n- [ ] Writes valid JSONL with annotated hunks\n- [ ] Does NOT run analysis (separate step)\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T14:49:40.781924-08:00","updated_at":"2025-12-26T16:33:15.877136-08:00","closed_at":"2025-12-26T16:33:15.877147-08:00","dependencies":[{"issue_id":"diffview-3zd","depends_on_id":"diffview-yj1","type":"blocks","created_at":"2025-12-26T14:49:52.77443-08:00","created_by":"daemon"}]}
{"id":"diffview-41i","title":"Create eval data directory structure","description":"## Problem\nNeed directory structure for eval cases and runs.\n\n## Entrypoints\n- Create `eval/` directory\n- Create `eval/.gitkeep` files\n\n## Structure\n```\neval/\n├── cases/      # JSONL test cases (extracted diffs)\n│   └── .gitkeep\n└── runs/       # Result files (with analyses + judgments)\n    └── .gitkeep\n```\n\n## Validation\n- [ ] Directories exist\n- [ ] .gitkeep files committed\n- [ ] make validate passes","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-26T14:49:41.218244-08:00","updated_at":"2025-12-26T15:26:32.144562-08:00","closed_at":"2025-12-26T15:26:32.144567-08:00"}
{"id":"diffview-488","title":"Add padding space between gutter and code prefix","description":"## Problem\nCurrently the line number gutter immediately abuts the +/-/space prefix of each code line. A small visual gap would improve readability.\n\n## Solution\nAdd one space of padding between the gutter and the code prefix (+/-/space). This padding should use the code line's background color (not the gutter's background), creating a clean visual transition.\n\n## Example\nCurrent:  `  12    14 +added line`\nDesired:  `  12    14  +added line` (extra space with code background)\n\n## Entrypoints\n- `bubbletea/viewer.go`: `renderDiff()` function where gutter and line content are joined\n\n## Validation\n- [ ] One space padding appears between gutter and code prefix\n- [ ] Padding uses code line background color (green for added, red for deleted, none for context)\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T20:58:06.124674-08:00","updated_at":"2025-12-25T22:53:44.502527-08:00","closed_at":"2025-12-25T22:53:44.502543-08:00"}
{"id":"diffview-4aj","title":"Add LLM-as-judge test integration","description":"## Problem\nNeed to integrate LLM-based evaluation into Go's test framework, following the Mattermost pattern.\n\n## Entrypoints\n- Create test helpers in appropriate location\n- Reference `docs/llm-evals-go.md` for patterns\n\n## Implementation\n```go\n// Run with: GOEVALS=1 go test ./...\nfunc TestStoryGeneration(t *testing.T) {\n    if os.Getenv(\"GOEVALS\") == \"\" {\n        t.Skip(\"GOEVALS not set\")\n    }\n\n    result := generateStory(loadDiff(\"testdata/feature-add.diff\"))\n\n    assertRubric(t, \"correctly classifies change type\", result)\n    assertRubric(t, \"identifies core hunks vs supporting\", result)\n}\n```\n\n## Key Components\n- `assertRubric(t, criterion, output)` - sends to LLM for evaluation\n- Opt-in via environment variable\n- Results logged for analysis\n\n## Validation\n- [ ] Tests skip when GOEVALS not set\n- [ ] Tests run and call LLM when GOEVALS=1\n- [ ] Rubric failures reported as test failures\n- [ ] make validate passes (without GOEVALS)","notes":"COMPLETED: \n- Added RubricJudge interface and RubricResult type in rubric.go\n- Created eval/ package with Eval struct, AssertRubric helper, and SkipUnlessEvals\n- Added mock.RubricJudge \n\nVALIDATION: make validate passes\n\nUSAGE EXAMPLE:\n```go\nfunc TestStoryGeneration(t *testing.T) {\n    eval.SkipUnlessEvals(t) // Skips unless GOEVALS=1\n\n    judge := gemini.NewJudge(client, model)\n    e := eval.New(judge)\n\n    result := generateStory(loadDiff(\"testdata/feature.diff\"))\n    e.AssertRubric(t, \"correctly classifies change type\", result)\n}\n```\n\nNEXT: Self-review before finishing","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T14:49:42.091631-08:00","updated_at":"2025-12-26T19:13:49.34946-08:00","closed_at":"2025-12-26T19:13:49.349465-08:00","dependencies":[{"issue_id":"diffview-4aj","depends_on_id":"diffview-szv","type":"blocks","created_at":"2025-12-26T14:49:52.873988-08:00","created_by":"daemon"}]}
{"id":"diffview-51z","title":"Add colorblind-friendly theme using blue/orange palette","description":"## Problem\nCurrent red/green color scheme is problematic for ~8% of men with deuteranopia/protanopia (red-green colorblindness). Added and deleted lines may be indistinguishable.\n\n## Solution\nAdd a colorblind-friendly theme using blue/orange (or cyan/peach) which have:\n- Very different perceived lightness\n- Work across all common colorblindness types\n- Blue is perceived similarly by almost everyone\n\n## Implementation\n```go\nfunc ColorblindTheme() *Theme {\n    return \u0026Theme{\n        styles: diffview.Styles{\n            Added: diffview.ColorPair{\n                Foreground: \"#74c7ec\", // Cyan/sky blue\n            },\n            Deleted: diffview.ColorPair{\n                Foreground: \"#fab387\", // Orange/peach\n            },\n            Context: diffview.ColorPair{\n                Foreground: \"#6c7086\", // Muted gray\n            },\n            HunkHeader: diffview.ColorPair{\n                Foreground: \"#cba6f7\", // Mauve (distinct from both)\n            },\n            FileHeader: diffview.ColorPair{\n                Foreground: \"#f9e2af\",\n                Background: \"#313244\",\n            },\n        },\n    }\n}\n```\n\n## References\n- https://davidmathlogic.com/colorblind/\n- https://www.smashingmagazine.com/2024/02/designing-for-colorblindness/\n\n## Entrypoints\n- lipgloss/theme.go (add ColorblindTheme function)\n\n## Validation\n- [ ] ColorblindTheme() function exists and returns valid theme\n- [ ] Colors are distinguishable in colorblind simulators\n- [ ] Test with deuteranopia/protanopia simulation tools\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-23T23:55:40.144182-08:00","updated_at":"2025-12-24T15:14:09.23911-08:00","closed_at":"2025-12-24T15:14:09.23911-08:00","close_reason":"Pausing: visual direction shifting from full-background colors to gutter-mark-based minimal UI. Will revisit accessibility themes once new primitives are in place."}
{"id":"diffview-56j","title":"Create gemini package with StoryGenerator","description":"## Problem\nNeed Gemini API client and StoryGenerator implementation, borrowing patterns from locdoc.\n\n## Entrypoints\n- Create `gemini/gemini.go` - client wrapper\n- Create `gemini/generator.go` - StoryGenerator implementation\n- Reference `../locdoc/gemini/` for patterns\n\n## Implementation\n\n**Client wrapper**\n- Client struct with genai.Client and model string\n- NewClient(ctx, model) constructor\n- Close() method\n\n**Generator**\n- Implements diffview.StoryGenerator\n- Formats hunks with IDs for prompt\n- Sends to Gemini with JSON schema\n- Parses response into DiffAnalysis\n\n## Validation\n- [ ] Can create client with API key from env\n- [ ] Implements StoryGenerator interface (compile-time check)\n- [ ] Unit tests with mocked Gemini responses\n- [ ] make validate passes","notes":"## Architectural Notes from diffview-eju\n\n### Interface Contract\nThe StoryGenerator.Generate method signature is:\n```go\nGenerate(ctx context.Context, hunks []AnnotatedHunk) (*DiffAnalysis, error)\n```\n\n### Key Implementation Details:\n\n1. **AnnotatedHunk embeds Hunk**: File path is NOT in AnnotatedHunk - the CLI layer (diffview-yj1) is responsible for encoding file context in the ID string if needed for prompt construction.\n\n2. **DiffAnalysis.Version is int**: For simpler schema evolution comparisons.\n\n3. **json.RawMessage for Payload**: The Analysis type uses json.RawMessage for extensibility. Marshal StoryAnalysis to JSON and assign to Payload.\n\n4. **Compile-time check pattern**:\n```go\nvar _ diffview.StoryGenerator = (*Generator)(nil)\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T14:49:39.929556-08:00","updated_at":"2025-12-26T15:09:58.187098-08:00","closed_at":"2025-12-26T15:09:58.187098-08:00","close_reason":"Closed","dependencies":[{"issue_id":"diffview-56j","depends_on_id":"diffview-eju","type":"blocks","created_at":"2025-12-26T14:49:52.707156-08:00","created_by":"daemon"}]}
{"id":"diffview-578","title":"Implement language detection from diff headers","description":"## Problem\nNeed to detect programming language from diff file paths like \"+++ b/src/foo.go\".\n\n## Implementation\nUse lexers.Match(filename) which handles extension-based detection.\n\n```go\nfunc lexerFromDiffPath(diffPath string) chroma.Lexer {\n    filename := strings.TrimPrefix(diffPath[4:], \"b/\")\n    filename = filepath.Base(filename)\n    if lexer := lexers.Match(filename); lexer != nil {\n        return lexer\n    }\n    return lexers.Fallback\n}\n```\n\n## Validation\n- [ ] Detects Go from .go files\n- [ ] Detects common languages (Python, TypeScript, Rust)\n- [ ] Falls back gracefully for unknown extensions\n- [ ] make validate passes","notes":"## Structural Review Findings (2025-12-25)\n\nREJECTED: Implementation worked but violated Ben Johnson Standard Package Layout.\n\n### Issues Found:\n\n1. **Wrong package placement**: `LexerFromDiffPath` placed in `chroma` package but parses diff headers (domain knowledge). Should be in root package.\n\n2. **Missing abstraction**: No domain interface for language detection. Downstream issue (diffview-imr) would need to import chroma directly, violating dependency injection.\n\n3. **Function signature assumes diff format**: Required \"+++ \" prefix when callers already have clean paths like \"b/src/foo.go\".\n\n### Required Structure:\n\n1. Add `LanguageDetector` interface to `syntax.go`:\n   ```go\n   type LanguageDetector interface {\n       DetectFromPath(path string) string\n   }\n   ```\n\n2. Create `chroma/detector.go` with implementation that:\n   - Accepts clean paths (\"b/src/foo.go\" or \"src/foo.go\")\n   - Strips b/ or a/ prefix internally\n   - Returns language name or empty string\n\n3. Bubbletea viewer depends on interface, wired in cmd/diffview/main.go\n\nThis preserves dependency injection and allows easy testing with mocks.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T20:16:00.910485-08:00","updated_at":"2025-12-25T12:44:50.624349-08:00","closed_at":"2025-12-25T12:44:50.624349-08:00","close_reason":"Closed","dependencies":[{"issue_id":"diffview-578","depends_on_id":"diffview-tsg","type":"blocks","created_at":"2025-12-24T20:16:09.282039-08:00","created_by":"daemon"}]}
{"id":"diffview-5tv","title":"Dim context lines for better change visibility","description":"## Problem\nContext lines are fairly visible (#cdd6f4) - similar prominence to changed lines. Changes don't pop as much as they could.\n\n## Solution\nReduce context line brightness significantly:\n- Current: #cdd6f4 (light gray)\n- Proposed: #6c7086 (muted gray)\n\nContext should fade into background so changes stand out.\n\n## Implementation\nSimple color change in theme definitions.\n\n## Entrypoints\n- lipgloss/theme.go:34 (DarkTheme context color)\n- lipgloss/theme.go:58 (LightTheme context color)\n\n## Validation\n- [ ] Context lines are visibly dimmer than changed lines\n- [ ] Still readable, not invisible\n- [ ] Changes pop more visually\n- [ ] make validate passes","status":"closed","priority":4,"issue_type":"feature","created_at":"2025-12-23T23:51:21.305346-08:00","updated_at":"2025-12-24T12:42:17.086243-08:00","closed_at":"2025-12-24T12:42:17.086254-08:00"}
{"id":"diffview-5yi","title":"Remove unused word-level diff infrastructure","description":"## Problem\nAfter simplifying diff styling, the word-level diff infrastructure is no longer used but still exists in the codebase.\n\n## Cleanup needed\n1. Remove `AddedHighlight` / `DeletedHighlight` from `Styles` struct in `styles.go`\n2. Remove these fields from `lipgloss/theme.go` stylesFromPalette\n3. Remove these fields from `bubbletea/viewer.go` defaultStyles\n4. Update tests in `styles_test.go` and `lipgloss/theme_test.go`\n5. Consider removing `worddiff/` package entirely (optional - could keep for future use)\n\n## Validation\n- [ ] make validate passes\n- [ ] No references to AddedHighlight/DeletedHighlight remain (except worddiff package if kept)","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T17:24:49.05928-08:00","updated_at":"2025-12-25T21:00:14.702021-08:00","closed_at":"2025-12-25T21:00:14.702021-08:00","close_reason":"Replaced with issue to restore word-level highlighting instead of removing it"}
{"id":"diffview-60l","title":"Change default theme to GitHub-inspired dark theme","description":"## Problem\nCurrently using Catppuccin Mocha theme. During development, it's easier to reference GitHub's diff view as prior art for visual decisions. Having a GitHub-inspired theme makes it simpler to validate our implementation against a known reference.\n\n## Solution\nCreate a GitHub-inspired dark theme as the default:\n- Background colors matching GitHub's dark mode diff view\n- Added lines: green-tinted background (GitHub uses ~#0d1117 base with green tint)\n- Deleted lines: red-tinted background\n- Gutter colors matching GitHub's approach\n- File headers, hunk headers styled similarly\n\n## Benefits\n- Easier to compare our output against GitHub when developing\n- No need to reinvent visual design decisions\n- Users familiar with GitHub will feel at home\n- Can always add Catppuccin as an alternative theme later\n\n## Reference\n- GitHub dark mode diff view: https://github.com (any PR or commit diff)\n- Current theme: Catppuccin Mocha in `lipgloss/theme.go`\n\n## Entrypoints\n- `lipgloss/theme.go`: `mochaPalette()` and `DefaultTheme()`\n- `bubbletea/viewer.go`: `defaultStyles()` and `defaultPalette()`\n\n## Validation\n- [ ] Default theme visually resembles GitHub dark mode diffs\n- [ ] All diff elements (added, deleted, context, headers, gutter) styled appropriately\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T21:01:38.581693-08:00","updated_at":"2025-12-26T11:32:20.66384-08:00","closed_at":"2025-12-26T11:32:20.663845-08:00"}
{"id":"diffview-6f7","title":"DiffStory Eval System","description":"## Goal\nBuild an evaluation system to validate LLM-based diff classification before integrating into the viewer.\n\n## Approach\nFollowing Hamel Husain's methodology:\n- Binary pass/fail with detailed critiques\n- Open coding → Axial coding for failure taxonomy\n- Single domain expert review\n\n## Design Doc\ndocs/plans/2025-12-26-diffstory-eval-design.md\n\n## Success Criteria\n- 30-50 classified diffs reviewed with critiques\n- Emergent failure taxonomy\n- Clear signal on classification prompt quality","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-26T21:31:05.500509-08:00","updated_at":"2025-12-26T22:24:14.978677-08:00","closed_at":"2025-12-26T22:24:14.97868-08:00"}
{"id":"diffview-6pz","title":"Add diff-aware line number gutter styling","description":"## Problem\nCurrently the line number gutter uses the same neutral style for all lines. GitHub uses colored backgrounds in the gutter area for added/deleted lines, making it easier to visually track where changes occur.\n\n## Solution\nApply diff-aware background colors to the line number gutter:\n- Added lines: stronger green background in gutter (e.g., 25-30% blend)\n- Deleted lines: stronger red background in gutter (e.g., 25-30% blend)\n- Context lines: keep neutral\n\nThe gutter content (line numbers) is less important than code, so a more contrasty background there helps the eye track additions/deletions without interfering with code readability.\n\n## Additional cleanup for uncluttered look\n- Remove `│` divider character - color transition provides visual separation\n- Remove `-` placeholders for missing line numbers - use empty space instead\n\n## Reference\nSee GitHub's diff view - clean gutter with colored backgrounds, no dividers or placeholders.\n\n## Entrypoints\n- `bubbletea/viewer.go`: `formatGutter()` function - remove divider and hyphen placeholders\n- `bubbletea/viewer.go`: `renderDiff()` - pass line type to gutter formatting\n\n## Validation\n- [ ] Line number gutter shows colored background for added/deleted lines\n- [ ] Divider character removed\n- [ ] Hyphen placeholders replaced with empty space\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-25T17:27:35.483796-08:00","updated_at":"2025-12-25T21:05:03.784455-08:00","closed_at":"2025-12-25T21:05:03.784455-08:00","close_reason":"Closed"}
{"id":"diffview-6rk","title":"Add status bar with scroll position, navigation info, and key hints","description":"## Problem\nThe diff viewer has no persistent UI showing where you are in the diff or how to navigate. Users must remember keybindings and have no sense of position in large diffs.\n\n## Solution\nAdd a status bar at the bottom showing:\n- Current file name and position (file 2/5)\n- Current hunk position (hunk 3/8)\n- Scroll percentage or Top/Bot indicator\n- Key hints: j/k:scroll n/N:hunk ]/[:file q:quit\n\n## Implementation\nUse Bubble Tea header/footer pattern from bubble-tea skill:\n- Modify View() to use JoinVertical with viewport + statusBarView()\n- Add currentFileIndex()/currentHunkIndex() methods (binary search positions)\n- Adjust viewport.Height in WindowSizeMsg to account for status bar height\n- Use lipgloss for styling with muted colors for less important info\n\n## Entrypoints\n- bubbletea/viewer.go:140 (View method)\n- bubbletea/viewer.go:123 (WindowSizeMsg handler)\n\n## Validation\n- [ ] Status bar visible at bottom of screen\n- [ ] Shows current file name and file X/Y position\n- [ ] Shows hunk X/Y position\n- [ ] Shows scroll percentage (or Top/Bot at edges)\n- [ ] Shows condensed key hints\n- [ ] Updates as user scrolls/navigates\n- [ ] make validate passes","notes":"COMPLETED: Status bar implementation with file/hunk positions, scroll indicator, and key hints\nIN_PROGRESS: Self-review\nKEY_DECISIONS: Used lipgloss.JoinVertical for layout, binary search for position tracking","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-23T23:51:09.919553-08:00","updated_at":"2025-12-24T00:22:22.956209-08:00","closed_at":"2025-12-24T00:22:22.956211-08:00"}
{"id":"diffview-6zz","title":"Research: diffview public API design","description":"## Problem\nDecide how users invoke diffview for LLM-powered features. Need an opinionated, minimal API that works well with current git-based workflows.\n\n## Questions to Answer\n- Pipe git output vs read from repo directly?\n- CLI flags vs config file vs convention?\n- What's the simplest happy path for 'show me this PR with AI context'?\n\n## Entrypoints\n- cmd/diffview/main.go (current CLI)\n- Consider cmd/diffstory integration\n\n## Validation\n- Document recommended invocation pattern\n- Prototype works with real PR workflow","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-26T20:13:04.674435-08:00","updated_at":"2025-12-26T20:13:04.674435-08:00"}
{"id":"diffview-75w","title":"Simplify status bar, move keybindings to help popup","description":"## Problem\nStatus bar shows too much: `file 1/2  hunk 3/16  22%  j/k:scroll  n/N:hunk  ]/[:file  q:quit`\n\nKeybinding hints are useful for learning but create constant visual noise for experienced users.\n\n## Solution\n1. Reduce status bar to essential info: `1/2 · 22%` (file position and progress)\n2. Show keybindings in popup/overlay when user presses `?`\n3. Popup disappears on any keypress\n\n## Design Direction\nPart of 'less is more' refresh. The status bar should be almost invisible - just enough to maintain orientation.\n\n## Implementation Notes\n- Bubble Tea has overlay/popup patterns\n- Could be modal (blocks input until dismissed) or toast-style (dismisses on any key)\n- Keybindings popup should be comprehensive since it's the only place they appear\n\n## Entrypoints\n- bubbletea/viewer.go (status bar rendering, key handling)\n\n## Validation\n- [ ] Status bar shows only position/progress\n- [ ] Pressing ? shows keybinding help\n- [ ] Help dismisses on any keypress\n- [ ] All keybindings documented in help popup\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T15:26:21.082397-08:00","updated_at":"2025-12-25T21:03:37.630173-08:00","closed_at":"2025-12-25T21:03:37.630173-08:00","close_reason":"Design direction changed - will revisit after GitHub-inspired theme"}
{"id":"diffview-7cs","title":"Show empty file creations in diff view","description":"## Problem\nNewly created empty files (like .gitkeep) are not shown in diffview output, even though they appear in git diff and GitHub shows them as \"Whitespace-only changes\".\n\nThis reveals a gap in what we parse vs what we display - the gitdiff parser likely captures these files, but the renderer may skip them because there are no hunks/lines to show.\n\n## Reproduction\n1. Create empty files: `touch eval/cases/.gitkeep eval/runs/.gitkeep`\n2. Commit them\n3. Run `git diff origin/main | go run ./cmd/diffview`\n4. Only .beads/issues.jsonl shows - empty files are missing\n\n## Expected\nEmpty file creations should appear in the file list with an indicator like \"(empty file)\" or \"(new empty file)\".\n\n## Entrypoints\n- `gitdiff/parser.go` - check if empty files are parsed\n- `bubbletea/model.go` - check if files with no hunks are filtered out\n\n## Validation\n- [ ] Empty file creations appear in diff view\n- [ ] Empty file deletions appear in diff view\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-26T15:29:40.76794-08:00","updated_at":"2025-12-26T15:44:02.856172-08:00","closed_at":"2025-12-26T15:44:02.856184-08:00"}
{"id":"diffview-7u3","title":"Diff renderer with styling","description":"## Problem\nThe viewer doesn't render diffs properly. It just dumps raw `line.Content` with no formatting.\n\n## Missing Features\n- File headers (`--- a/file`, `+++ b/file`)\n- Hunk headers (`@@ -1,5 +1,10 @@`)\n- Line prefixes (`+`/`-`/` ` for added/deleted/context)\n- Colors from the styling system (`lipgloss/theme.go` exists but isn't used)\n\n## Entrypoints\n- `bubbletea/viewer.go:renderDiffWithPositions()` - current renderer\n- `lipgloss/theme.go` - theme/colors to apply\n- `diffview.go` - domain types (Line.Type, Styles, etc.)\n\n## Validation\n- [ ] File headers shown with yellow/background styling\n- [ ] Hunk headers shown with blue styling\n- [ ] Added lines green with + prefix\n- [ ] Deleted lines red with - prefix\n- [ ] Context lines gray with space prefix\n- [ ] make validate passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T22:31:49.164312-08:00","updated_at":"2025-12-23T23:12:11.854847-08:00","closed_at":"2025-12-23T23:12:11.854847-08:00","close_reason":"Implemented full diff rendering with styling:\n- File headers (--- a/..., +++ b/...) with yellow/dark background\n- Hunk headers (@@ ... @@) with blue styling\n- Added lines (+) in green\n- Deleted lines (-) in red  \n- Context lines ( ) in gray\n- Fixed double line spacing bug (closed diffview-dgu)\n- All tests pass, make validate passes","dependencies":[{"issue_id":"diffview-7u3","depends_on_id":"diffview-lzy","type":"blocks","created_at":"2025-12-23T22:32:08.460312-08:00","created_by":"daemon"}]}
{"id":"diffview-831","title":"Remove hunk headers (@@ markers)","description":"## Problem\nHunk headers like `@@ -589,13 +586,14 @@` are git plumbing. They communicate line ranges that mean nothing to someone reviewing AI-generated code. They add visual noise without aiding comprehension.\n\n## Solution\nRemove hunk headers entirely. Whitespace between hunks (diffview-3xh) provides sufficient visual grouping.\n\n## Design Direction\nPart of 'less is more' refresh. The hunk header is an artifact of the `diff -u` format, not something designed for human comprehension.\n\nFuture: When the 'intelligence layer' exists, semantic labels could replace these (e.g., 'Modified error handling in fetchUser'). For now, nothing is better than noise.\n\n## Entrypoints\n- tui/render.go (hunk rendering)\n- Possibly bubbletea/viewer.go\n\n## Dependencies\nShould come after diffview-3xh (whitespace between hunks) so there's still visual separation.\n\n## Validation\n- [ ] No @@ lines appear in rendered output\n- [ ] Hunks still visually separated (via whitespace)\n- [ ] Navigation between hunks still works (n/N keys)\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T15:26:30.154792-08:00","updated_at":"2025-12-26T11:57:38.03929-08:00","closed_at":"2025-12-26T11:57:38.03929-08:00","close_reason":"Won't do - part of an old idea that was decided against","dependencies":[{"issue_id":"diffview-831","depends_on_id":"diffview-3xh","type":"blocks","created_at":"2025-12-24T15:26:33.900718-08:00","created_by":"daemon"}]}
{"id":"diffview-8go","title":"Research: Prior art on narrative-driven code change comprehension","description":"## Problem\nWe want to transform how developers comprehend code changes - from line-by-line inspection to understanding what a change *means* for a system. Before building, we need to map existing thinking in this space.\n\n## Research Query\n\n**Core Question:** How do experts make sense of code changes, and what structures help them do it faster?\n\n### 1. Cognitive Science of Change Comprehension\n- How do experienced developers build mental models when reviewing unfamiliar changes?\n- What's known about chunking, pattern recognition, and the role of narrative in technical comprehension?\n- Letovsky's code comprehension framework (specification/implementation/annotation layers) - what research built on this?\n- Studies on how reviewers prioritize attention across multi-file changes\n\n### 2. Famous Code Review Cultures\n- Linux kernel mailing list practices (Linus Torvalds' feedback style, patch series structure)\n- How do high-quality open source projects structure their review processes?\n- Google's internal code review research (the 24-line median, 4-hour turnaround findings)\n- What makes a 'good' commit message according to various traditions?\n\n### 3. Change Classification \u0026 Narrative Patterns\n- Is there established taxonomy for types of code changes? (refactoring vs feature vs bugfix vs...)\n- How do different change types map to different comprehension strategies?\n- The 'story arc' of a change - is there prior art on presenting changes as narratives?\n- Commit archaeology - how do historians of code think about change sequences?\n\n### 4. Semantic Diff \u0026 Beyond-Line-Level Tools\n- SemanticDiff, Difftastic, AST-aware diff approaches - what problems do they solve?\n- Academic work on program differencing\n- Change impact analysis literature\n- Tools that group changes by 'operation' rather than file\n\n### 5. AI-Specific Review Considerations\n- Emerging research on reviewing LLM-generated code\n- Automation bias in code review contexts\n- The 'prompt as source code' framing - anyone else exploring this?\n\n### 6. Adjacent Fields\n- How do other domains present complex changes for human review? (legal redlines, academic revision tracking, design version control)\n- Journalism - how do editors review and understand article changes?\n- What can we learn from how scientific papers structure 'what changed' sections?\n\n## Desired Output\n- Annotated bibliography of key papers, posts, talks\n- Taxonomy of existing approaches with tradeoffs\n- Gaps in current thinking that represent opportunities\n- Specific ideas we should steal/adapt\n- People/communities worth following on this topic\n\n## Entrypoints for Context\n- docs/intellingent-diff-presentation.md (our current cognitive science synthesis)\n- docs/from-diff-viewer-to-feedback-interface.md (our philosophical framing)\n- docs/plans/2025-12-26-diff-story-generator-design.md (current implementation direction)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T20:18:09.23809-08:00","updated_at":"2025-12-26T20:19:55.728439-08:00","closed_at":"2025-12-26T20:19:55.728439-08:00","close_reason":"Research query prepared for external deep research agent"}
{"id":"diffview-8k9","title":"Update viewer to use Theme","description":"## Problem\nViewer has hardcoded colors in defaultStyles() and statusBarView().\n\n## Implementation\n1. Add `WithTheme(t Theme)` option to viewer\n2. Store theme and cached syntaxStyle in Viewer struct\n3. Update renderDiff() to use theme.Styles()\n4. Update statusBarView() to use theme.Palette() UI colors\n5. Remove defaultStyles() and all hardcoded color values\n6. Update existing tests to use TestTheme()\n\n## Entrypoints\n- bubbletea/viewer.go\n- bubbletea/viewer_test.go\n\n## Testing\n- Behavior tests use TestTheme() per bubble-tea skill patterns\n- Verify colors apply with trueColorRenderer()\n- No tests should break from theme aesthetic changes\n\n## Validation\n- [ ] WithTheme() option works\n- [ ] All hardcoded colors removed\n- [ ] Tests use TestTheme() pattern\n- [ ] make validate passes","notes":"## Background Color Migration Note (from diffview-eko)\n\nCurrent status:\n- lipgloss Theme.Styles() has NO backgrounds for Added/Deleted (only foregrounds)\n- Old DarkTheme had subtle backgrounds (#004000, #3f0001) but stylesFromPalette() doesn't derive these\n\nArchitectural decision: Start with foreground-only styling for simplicity.\nIf subtle backgrounds prove important for readability, can extend Palette with AddedBackground/DeletedBackground fields.\n\n## TestTheme Usage\nTestTheme() provides predictable pure colors (#00ff00, #ff0000) for test assertions.\nUse with trueColorRenderer() to verify colors are applied correctly.\n\n## Tokenizer Integration (from diffview-8tm)\nTo create a syntax-highlighting tokenizer from a theme:\n```go\nstyleFunc := chroma.StyleFromPalette(theme.Palette())\ntokenizer, err := chroma.NewTokenizer(styleFunc)\nif err != nil {\n    // handle error (nil styleFunc was passed)\n}\n```\n\nNote: NewTokenizer returns an error if styleFunc is nil. Create the styleFunc once when the theme is set, not on every tokenize call.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T13:53:30.041843-08:00","updated_at":"2025-12-25T16:00:38.20997-08:00","closed_at":"2025-12-25T16:00:38.209975-08:00","dependencies":[{"issue_id":"diffview-8k9","depends_on_id":"diffview-eko","type":"blocks","created_at":"2025-12-25T13:53:41.946114-08:00","created_by":"daemon"},{"issue_id":"diffview-8k9","depends_on_id":"diffview-8tm","type":"blocks","created_at":"2025-12-25T13:53:42.036127-08:00","created_by":"daemon"}]}
{"id":"diffview-8tm","title":"Add StyleFromPalette to chroma/","description":"## Problem\nchroma/ needs to generate Chroma styles from Palette.\n\n## Implementation\n1. Add `StyleFromPalette(p diffview.Palette) *chroma.Style` function\n2. Map Palette colors to Chroma TokenTypes:\n   - Keyword → chroma.Keyword (bold)\n   - String → chroma.String\n   - Number → chroma.Number\n   - Comment → chroma.Comment (italic)\n   - Operator → chroma.Operator\n   - Function → chroma.NameFunction\n   - Type → chroma.KeywordType\n   - Constant → chroma.NameConstant\n   - Punctuation → chroma.Punctuation\n3. Remove hardcoded One Dark colors from tokenizer\n4. Move interface compliance check from test to production code\n\n## Entrypoints\n- chroma/style.go (new file)\n- chroma/tokenizer.go (remove hardcoded colors)\n\n## Testing\n- Verify StyleFromPalette generates valid Chroma style\n- Verify tokenizer still works with palette-generated style\n\n## Validation\n- [ ] StyleFromPalette works\n- [ ] Hardcoded One Dark colors removed\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T13:53:29.814594-08:00","updated_at":"2025-12-25T14:57:39.240313-08:00","closed_at":"2025-12-25T14:57:39.240313-08:00","close_reason":"Implemented StyleFromPalette function that creates style mapper from Palette. Updated Tokenizer to accept StyleFunc at construction, removing hardcoded One Dark colors. Tests verify all palette color mappings.","dependencies":[{"issue_id":"diffview-8tm","depends_on_id":"diffview-q24","type":"blocks","created_at":"2025-12-25T13:53:41.859639-08:00","created_by":"daemon"}]}
{"id":"diffview-99k","title":"Add high-contrast theme for maximum visibility","description":"## Problem\nCatppuccin-inspired pastel colors prioritize aesthetics over contrast. Some users need higher contrast for visibility, especially in bright environments or with visual impairments.\n\n## Solution\nAdd a high-contrast theme with bold, saturated colors:\n- Pure or near-pure hues\n- Maximum lightness difference between elements\n- Stark backgrounds for changed lines\n\n## Implementation\n```go\nfunc HighContrastTheme() *Theme {\n    return \u0026Theme{\n        styles: diffview.Styles{\n            Added: diffview.ColorPair{\n                Foreground: \"#00ff00\", // Pure green\n            },\n            Deleted: diffview.ColorPair{\n                Foreground: \"#ff4444\", // Bright red\n            },\n            Context: diffview.ColorPair{\n                Foreground: \"#888888\", // Medium gray (dim)\n            },\n            HunkHeader: diffview.ColorPair{\n                Foreground: \"#00ffff\", // Cyan\n            },\n            FileHeader: diffview.ColorPair{\n                Foreground: \"#ffff00\", // Yellow\n                Background: \"#333333\",\n            },\n        },\n    }\n}\n```\n\n## Entrypoints\n- lipgloss/theme.go (add HighContrastTheme function)\n\n## Validation\n- [ ] HighContrastTheme() function exists\n- [ ] Colors are highly saturated and distinct\n- [ ] Passes WCAG AAA contrast requirements\n- [ ] make validate passes","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-23T23:55:40.355118-08:00","updated_at":"2025-12-24T15:14:09.252025-08:00","closed_at":"2025-12-24T15:14:09.252025-08:00","close_reason":"Pausing: visual direction shifting from full-background colors to gutter-mark-based minimal UI. Will revisit accessibility themes once new primitives are in place."}
{"id":"diffview-9be","title":"Create difflib package with tokenizer","description":"## Task\nCreate the new difflib/ package with the tokenizer implementation. TDD approach.\n\n## Entrypoints\n- difflib/difflib.go (new)\n- difflib/difflib_test.go (new)\n\n## Implementation\n1. Create difflib/difflib.go with:\n   - Differ struct with pre-compiled tokenPattern regex\n   - NewDiffer() constructor\n   - tokenize(s string) []string method\n2. Write tests for tokenizer covering:\n   - Identifiers: `func`, `myVariable`\n   - Numbers: `123`, `3.14`\n   - Strings: `\"hello\"`, `'x'`\n   - Operators: `+`, `:=`, `==`\n   - Punctuation: `(`, `)`, `{`, `}`\n   - Whitespace preserved as separate tokens\n\n## Validation\n- [ ] tokenize() correctly splits code into tokens\n- [ ] Whitespace preserved as separate tokens\n- [ ] go test ./difflib/... passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:07:20.522372-08:00","updated_at":"2025-12-26T00:25:25.499629-08:00","closed_at":"2025-12-26T00:25:25.499629-08:00","close_reason":"Closed","dependencies":[{"issue_id":"diffview-9be","depends_on_id":"diffview-bua","type":"blocks","created_at":"2025-12-26T00:07:29.505701-08:00","created_by":"daemon"}]}
{"id":"diffview-9d2","title":"Restore word-level diff highlighting (GitHub-style)","description":"## Problem\nWord-level diff highlighting was removed in PR #28 to simplify styling. This feature helps reviewers quickly identify exactly what changed within a line, not just that the line changed.\n\n## Goal\nRestore word-level highlighting that works correctly, matching GitHub's behavior:\n- Within added lines: highlight the specific text that was added\n- Within deleted lines: highlight the specific text that was deleted\n- Paired lines (delete followed by add) should show what changed between them\n\n## Research needed\nReview how GitHub implements word-level diffs:\n- How are paired lines detected?\n- What algorithm is used (Myers diff, patience diff, token-based)?\n- How are highlights rendered (background color intensity)?\n- Edge cases: whitespace changes, moved blocks, multiple changes per line\n\n## Reference\n- PR #28: https://github.com/fwojciec/diffview/pull/28 (removed the feature)\n- Existing infrastructure: `worddiff/` package, `AddedHighlight`/`DeletedHighlight` styles\n\n## Entrypoints\n- `worddiff/` package: existing word diff implementation\n- `bubbletea/viewer.go`: rendering logic\n- `styles.go`: `AddedHighlight`/`DeletedHighlight` ColorPairs\n\n## Validation\n- [ ] Word-level highlights appear within changed lines\n- [ ] Behavior matches GitHub's diff view\n- [ ] Works with syntax highlighting\n- [ ] make validate passes","notes":"## Design\n- Line pairing: runs of consecutive deletes followed by consecutive adds are paired 1:1\n- For paired lines: use worddiff.Differ to compute segments  \n- Render changed segments with AddedHighlight/DeletedHighlight\n- Non-paired adds/deletes: entire line is highlighted (no word diff)\n\n## GitHub-style coloring\n- Same foreground color throughout the line (neutral text, not reversed)\n- Changed segments: gutter-intensity background (35% blend)\n- Unchanged segments: dimmed line background (15% blend)\n\n## Similarity threshold (30%)\n- Word-level highlighting only applied when ≥30% of content is unchanged\n- Avoids noise when lines are completely different\n\n## Line pairing algorithm\n- Finds runs of consecutive deleted lines\n- Finds immediately following run of consecutive added lines\n- Pairs them 1:1: 1st delete ↔ 1st add, 2nd delete ↔ 2nd add, etc.\n- Handles both simple pairs and multi-line block changes","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-25T21:00:25.276383-08:00","updated_at":"2025-12-25T23:42:24.005003-08:00","closed_at":"2025-12-25T23:42:24.00501-08:00"}
{"id":"diffview-9mj","title":"De-emphasize line numbers, show only for changed lines","description":"## Problem\nDual-column line numbers (old + new) add visual clutter. For AI-generated code review, line numbers are rarely referenced - the reviewer didn't write the original code, so 'line 543' has no meaning.\n\n## Solution\n1. Hide line numbers for context lines entirely\n2. Show line numbers only for added/deleted lines (so they can be referenced if needed)\n3. Style remaining numbers in muted/dim color so they don't compete with code\n4. Consider: show only new line number, not old (simpler, forward-looking)\n\n## Design Direction\nPart of 'less is more' refresh. Line numbers appearing only on changes creates natural visual hierarchy - your eye is drawn to numbers when they appear because they're not everywhere.\n\nThis is a step toward potentially removing line numbers entirely later, but validates the direction incrementally.\n\n## Current State\n- Two columns: old line number | new line number\n- Shown for every line\n- Followed by gutter symbol\n\n## Proposed State\n- Single column (new line number) or none\n- Shown only for changed lines\n- Very muted styling\n\n## Entrypoints\n- tui/render.go (formatGutter, line number formatting)\n\n## Validation\n- [ ] Context lines show no line numbers\n- [ ] Changed lines show line number (muted style)\n- [ ] Visual clutter reduced compared to current\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T15:19:20.303998-08:00","updated_at":"2025-12-25T21:03:37.6263-08:00","closed_at":"2025-12-25T21:03:37.6263-08:00","close_reason":"Design direction changed - will revisit after GitHub-inspired theme"}
{"id":"diffview-9vc","title":"Implement Differ.Diff with token-based algorithm","description":"## Task\nImplement the core Diff() method using token-based diffing with similarity threshold. TDD approach.\n\n## Entrypoints\n- difflib/difflib.go\n- difflib/difflib_test.go\n\n## Implementation\n1. Implement Diff(old, new string) (oldSegs, newSegs []Segment):\n   - Fast path: old == new → single unchanged segment\n   - Tokenize both strings\n   - Use SequenceMatcher.GetMatchingBlocks() (compute once)\n   - Calculate ratio from blocks\n   - If ratio \u003c 0.4 → return everything as changed\n   - Build segments from matching blocks\n   - Merge adjacent segments\n\n2. Tests covering:\n   - No partial identifiers: myVariable → myValue\n   - Similarity threshold behavior\n   - Empty strings, identical strings\n   - Unicode support\n   - Token boundaries (operators, whitespace)\n\n## Validation\n- [ ] No partial identifier highlighting\n- [ ] Low similarity → full replacement\n- [ ] go test ./difflib/... passes","notes":"## Integration Notes (from diffview-9be)\n\nThe Differ struct is already set up with tokenizer. Key implementation details:\n\n1. **Tokenize is exported**: Use d.Tokenize(s) directly (public method on Differ)\n\n2. **Interface compliance**: worddiff.Differ implements diffview.WordDiffer. The new difflib.Differ should also implement this interface. Add compile-time check:\n   var _ diffview.WordDiffer = (*Differ)(nil)\n\n3. **Segment type**: Use diffview.Segment from the root package (already exists, lines 79-84 of diffview.go)\n\n4. **Signature must match**: Diff(old, new string) (oldSegs, newSegs []Segment) - same as existing WordDiffer\n\n5. **Merge pattern**: See worddiff/worddiff.go for the existing mergeSegments helper - consider reusing or copying this pattern","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:07:20.71134-08:00","updated_at":"2025-12-26T08:28:13.268099-08:00","closed_at":"2025-12-26T08:28:13.268105-08:00","dependencies":[{"issue_id":"diffview-9vc","depends_on_id":"diffview-9be","type":"blocks","created_at":"2025-12-26T00:07:29.595714-08:00","created_by":"daemon"}]}
{"id":"diffview-a2m","title":"Section-aware diff rendering","description":"## Problem\nCurrent diff viewers (diffview, evalreview) render diffs linearly by file/hunk. With PR-level diffs containing 20+ hunks across many files, linear navigation is insufficient. The StoryClassification organizes hunks into narrative sections, but the UI doesn't leverage this.\n\n## Current State\n- HunkRef has Collapsed and CollapseText fields - not implemented\n- HunkRef has Category field (core, noise, etc.) - not used for styling\n- Sections group hunks with Role/Title/Explanation - displayed as text only\n- No mapping from rendered hunk position to its section\n\n## Required Capabilities\n\n### 1. Section Navigation\n- Jump to next/previous section (keybind: s/S or similar)\n- Section indicator in status bar: section 2/5: Core Changes\n- Optional: section list panel for overview\n\n### 2. Hunk Collapsing\n- Hunks with Collapsed=true render as single line showing CollapseText\n- Toggle expand/collapse per hunk (keybind: Enter or o)\n- Toggle all collapsed (keybind: z)\n\n### 3. Category-Based Styling\n- Visual distinction for hunk categories:\n  - core: prominent (normal)\n  - refactoring: dimmed\n  - systematic: dimmed, maybe grouped\n  - noise: very dimmed or hidden by default\n\n### 4. Section-Grouped Rendering (optional)\n- Mode to reorder hunks by section rather than file\n- Shows narrative flow instead of file structure\n\n## Entrypoints\n- bubbletea/viewer.go - core diff rendering\n- bubbletea/eval.go - eval review UI\n- classification.go - Section, HunkRef types\n\n## Validation\n- [ ] Can navigate between sections with keyboard\n- [ ] Collapsed hunks render as single line\n- [ ] Category affects hunk visual treatment\n- [ ] Section indicator in status bar","notes":"Performance baseline from diffview-ohe: 7.6MB diffs render in ~50ms with ~23MB memory. Section-aware rendering should maintain these bounds. Tests in bubbletea/large_diff_test.go provide benchmarks for regression tracking.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-27T10:51:17.85682-08:00","created_by":"filip","updated_at":"2025-12-27T13:49:02.644239-08:00","dependencies":[{"issue_id":"diffview-a2m","depends_on_id":"diffview-mle","type":"blocks","created_at":"2025-12-27T10:51:25.390636-08:00","created_by":"daemon"}]}
{"id":"diffview-ant","title":"Main wiring","description":"cmd/diffview/main.go - stdin detection, parser + viewer wiring, error handling, exit codes.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-23T18:49:12.187088-08:00","updated_at":"2025-12-23T22:25:18.355404-08:00","closed_at":"2025-12-23T22:25:18.355408-08:00","dependencies":[{"issue_id":"diffview-ant","depends_on_id":"diffview-lzy","type":"parent-child","created_at":"2025-12-23T18:49:42.436068-08:00","created_by":"daemon"},{"issue_id":"diffview-ant","depends_on_id":"diffview-w0d","type":"blocks","created_at":"2025-12-23T18:49:53.79042-08:00","created_by":"daemon"},{"issue_id":"diffview-ant","depends_on_id":"diffview-m9i","type":"blocks","created_at":"2025-12-23T18:49:53.868288-08:00","created_by":"daemon"}]}
{"id":"diffview-arm","title":"Reduce background color intensity for changed lines","description":"## Problem\nFull-saturation red/green backgrounds for added/deleted lines create visual noise. Every changed line screams at equal volume, making it hard to focus on what actually matters.\n\n## Solution\nMiddle ground approach:\n1. Keep colored gutter symbol (+/-) as primary indicator\n2. Reduce background to subtle tint (10-20% opacity feel) rather than full saturation\n3. Let word-level highlighting (yellow boxes for modifications) become the primary 'what changed' signal\n\n## Design Direction\nPart of 'less is more' visual refresh. The goal is scannable-at-distance (gutter symbols) + readable-up-close (subtle backgrounds don't fight syntax highlighting).\n\n## Trade-offs\n- Less 'loud' than current approach\n- May need to iterate on exact tint levels\n- Preserves scannability via gutter, improves readability via reduced backgrounds\n\n## Entrypoints\n- lipgloss/theme.go (color definitions)\n- tui/render.go (background application)\n\n## Validation\n- [ ] Gutter symbols (+/-) remain clearly visible and colored\n- [ ] Background tint is noticeably more subtle than current\n- [ ] Word-level change highlighting remains visible\n- [ ] Code is more readable with syntax highlighting\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T15:19:09.987152-08:00","updated_at":"2025-12-25T21:03:37.621596-08:00","closed_at":"2025-12-25T21:03:37.621596-08:00","close_reason":"Design direction changed - will revisit after GitHub-inspired theme"}
{"id":"diffview-ay7","title":"Diff Story Generator","description":"## Overview\nLLM-powered analysis tool that generates structured \"stories\" from git diffs - classifying change types and segmenting hunks into narrative roles.\n\n## Goals\n1. Validate that LLM-generated stories help code review\n2. Build eval suite to systematically improve story quality\n3. Create foundation for future viewer integration\n\n## Design Doc\ndocs/plans/2025-12-26-diff-story-generator-design.md\n\n## Tickets\nSee child issues for implementation breakdown.","notes":"## Architectural Notes from diffview-4aj\n\nA gemini.Judge implementation of diffview.RubricJudge will be needed when writing eval tests for story generation quality. The eval/ package provides:\n\n- `eval.New(judge)` - creates Eval struct with injected RubricJudge\n- `e.AssertRubric(t, criterion, output)` - test assertion that calls judge  \n- `eval.SkipUnlessEvals(t)` - skip unless GOEVALS=1\n\nPattern for future eval tests:\n```go\nfunc TestStoryQuality(t *testing.T) {\n    eval.SkipUnlessEvals(t)\n    \n    judge := gemini.NewJudge(client, model) // To be implemented\n    e := eval.New(judge)\n    \n    story := generator.Generate(ctx, hunks)\n    e.AssertRubric(t, \"correctly classifies change type\", story.Summary)\n}\n```\n\nThe gemini.Judge implementation should follow the existing gemini.Generator pattern:\n- Accept GenerativeClient interface (not concrete *Client)\n- Use var _ diffview.RubricJudge = (*Judge)(nil) compile-time check","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-26T14:48:46.636553-08:00","updated_at":"2025-12-26T20:01:42.242287-08:00","closed_at":"2025-12-26T20:01:42.242287-08:00","close_reason":"All implementation phases complete: story generator, collection tooling, evalreview TUI, and LLM-as-judge integration"}
{"id":"diffview-b9h","title":"Coordinate terminal color profiles between chroma and lipgloss","description":"## Problem\nChroma doesn't auto-detect terminal capabilities; must coordinate with Lipgloss.\n\n## Implementation\nDetect once and match both libraries:\n\n```go\nfunc getFormatterName() string {\n    if ct := os.Getenv(\"COLORTERM\"); ct == \"truecolor\" || ct == \"24bit\" {\n        return \"terminal16m\"\n    }\n    if strings.Contains(os.Getenv(\"TERM\"), \"256\") {\n        return \"terminal256\"\n    }\n    return \"terminal16\"\n}\n```\n\nConsider using lipgloss.CompleteColor for graceful degradation.\n\n## Validation\n- [ ] Works in true color terminal\n- [ ] Degrades gracefully in 256-color terminal\n- [ ] make validate passes","notes":"## Research Findings\n\n### Original Premise Was Outdated\nThe task assumed we'd coordinate between Chroma's formatters and Lipgloss. However, our architecture uses Chroma only for tokenization (lexing), not formatting. All color rendering flows through Lipgloss.\n\n### How Color Degradation Works\nLipgloss (via termenv) automatically handles color profile detection and degradation:\n- TrueColor terminals: hex colors pass through directly\n- ANSI256 terminals: hex colors are converted to nearest 256-color match\n- ANSI terminals: hex colors are converted to nearest 16-color match\n- NO_COLOR env var: colors are stripped entirely\n\n### What We Verified\n1. All colors in our codebase flow through `lipgloss.Color(hexValue)`\n2. Lipgloss auto-detects terminal capabilities when rendering\n3. Bubble Tea's terminal setup handles proper color context\n4. NO_COLOR is respected (verified via testing)\n\n### Why No Code Changes Needed\nThe architecture already achieves graceful degradation:\n- Palette stores hex colors (`diffview.Color`)\n- Lipgloss rendering calls `lipgloss.Color()` with those hex values\n- termenv (inside lipgloss) converts to terminal's capability level\n\n### Validation Criteria Met\n- ✅ Works in true color terminal (hex colors pass through)\n- ✅ Degrades gracefully in 256-color terminal (lipgloss auto-converts)\n- ✅ make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T20:16:02.798026-08:00","updated_at":"2025-12-26T11:52:45.17086-08:00","closed_at":"2025-12-26T11:52:45.17086-08:00","close_reason":"No code changes needed. Architecture already handles color degradation: Chroma is used only for tokenization (not formatting), all colors flow through Lipgloss which auto-detects terminal capabilities and degrades hex colors appropriately. Verified NO_COLOR support works. make validate passes.","dependencies":[{"issue_id":"diffview-b9h","depends_on_id":"diffview-imr","type":"blocks","created_at":"2025-12-24T20:16:09.722063-08:00","created_by":"daemon"}]}
{"id":"diffview-bt0","title":"Add whitespace before file headers","description":"## Problem\nFile headers sit directly against the last line of the previous file, creating visual cramping. With the denser, cleaner direction we're taking, file headers need room to breathe as primary organizational landmarks.\n\n## Solution\nAdd 1 blank line before each file header, except the first file in the diff.\n\n## Before\n```\n   }\n── tui/render.go ─────────────────────────── +15 -8 ──\n   // formatGutter formats...\n```\n\n## After\n```\n   }\n\n── tui/render.go ─────────────────────────── +15 -8 ──\n   // formatGutter formats...\n```\n\n## Design Direction\nPart of 'less is more' refresh. The space above says 'new section starting.' No space below needed - the header itself is the visual break.\n\n## Entrypoints\n- bubbletea/viewer.go (file header rendering loop)\n\n## Validation\n- [ ] Blank line appears before file headers (except first)\n- [ ] No blank line after file headers\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T15:37:21.560048-08:00","updated_at":"2025-12-25T21:03:37.633092-08:00","closed_at":"2025-12-25T21:03:37.633092-08:00","close_reason":"Design direction changed - will revisit after GitHub-inspired theme"}
{"id":"diffview-bua","title":"Add pmezard/go-difflib dependency","description":"## Task\nAdd the go-difflib dependency that will be used for token-based word diffing.\n\n## Entrypoints\n- go.mod\n\n## Implementation\n```bash\ngo get github.com/pmezard/go-difflib\n```\n\n## Validation\n- [ ] go.mod contains pmezard/go-difflib\n- [ ] go mod tidy succeeds","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:07:20.323117-08:00","updated_at":"2025-12-26T00:12:08.570229-08:00","closed_at":"2025-12-26T00:12:08.570229-08:00","close_reason":"Dependency already exists in go.mod (added via testify in commit abd0b7c)"}
{"id":"diffview-c9g","title":"Add benchmarks for difflib","description":"## Task\nAdd performance benchmarks to validate efficiency of token-based diffing.\n\n## Entrypoints\n- difflib/difflib_test.go\n\n## Implementation\nAdd BenchmarkDiffer_Diff with sub-benchmarks:\n- short_similar: similar short lines\n- short_different: very different short lines  \n- long_line: realistic long code line\n- identical: fast path test\n\nRun with: go test -bench=. -benchmem ./difflib/\n\n## Validation\n- [ ] Benchmarks run successfully\n- [ ] Performance \u003c 100ms per line pair (should be microseconds)\n- [ ] No excessive allocations","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:07:20.901844-08:00","updated_at":"2025-12-26T09:27:57.967109-08:00","closed_at":"2025-12-26T09:27:57.967109-08:00","close_reason":"Closed","dependencies":[{"issue_id":"diffview-c9g","depends_on_id":"diffview-9vc","type":"blocks","created_at":"2025-12-26T00:07:29.692745-08:00","created_by":"daemon"}]}
{"id":"diffview-ci2","title":"Audit codebase for manual line width calculations","description":"## Problem\nDuring diffview-1y9 implementation, we discovered that using `len(string)` for line width calculations is incorrect for multi-byte Unicode characters. The fix was to use `lipgloss.Width()` which handles display width correctly.\n\n## Action Items\n- [ ] Search codebase for `len(` patterns that might be calculating display widths\n- [ ] Replace with `lipgloss.Width()` where appropriate\n- [ ] Update bubbletea skill documentation with this important consideration\n\n## Context\n- `len(string)` counts bytes, not display characters\n- CJK characters are double-width (2 display cells) but 3 bytes each\n- Emoji can be 4 bytes but 2 display cells\n- `lipgloss.Width()` uses go-runewidth internally to handle these correctly\n\n## Validation\n- [ ] No remaining incorrect `len()` usage for display width\n- [ ] make validate passes","notes":"COMPLETED: Full codebase audit\nFINDINGS:\n- All existing len() usages are for slice lengths, not display widths\n- Codebase already correctly uses lipgloss.Width() in all display width calculations:\n  - bubbletea/viewer.go:237 (status bar)\n  - bubbletea/viewer.go:461 (file header fill)\n  - bubbletea/viewer.go:555-557 (line segment width)\n  - bubbletea/viewer.go:654 (padLine function)\n- bubbletea skill already documents the gotcha (lines 237-247)\n- No code changes required\n\nKEY INSIGHT: The fix from diffview-1y9 was comprehensive - no lingering issues found","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-24T08:13:29.055683-08:00","updated_at":"2025-12-25T12:53:47.689476-08:00","closed_at":"2025-12-25T12:53:47.689476-08:00","close_reason":"Audit complete: no incorrect len() usage found. Codebase already uses lipgloss.Width() correctly in all display width calculations."}
{"id":"diffview-cq1","title":"Collect and classify eval dataset","description":"## Problem\nNeed ~50 classified diffs from diffview and locdoc for human review.\n\n## Prerequisites\n- Classification prompt working\n- diffstory collect updated\n\n## Steps\n1. Collect from diffview:\n   ```bash\n   diffstory collect --limit=30 --min-lines=5 --max-lines=500 . \u003e diffview-cases.jsonl\n   ```\n\n2. Collect from locdoc:\n   ```bash\n   diffstory collect --limit=30 --min-lines=5 --max-lines=500 ../locdoc \u003e locdoc-cases.jsonl\n   ```\n\n3. Merge and dedupe:\n   ```bash\n   cat diffview-cases.jsonl locdoc-cases.jsonl \u003e all-cases.jsonl\n   ```\n\n4. Run classification on each case (script or manual)\n\n5. Output: `eval-dataset.jsonl` with story field populated\n\n## Target Composition\n| Type | Count |\n|------|-------|\n| Bugfix | 8-10 |\n| Feature | 15-20 |\n| Refactor | 8-10 |\n| Chore | 5-8 |\n| Docs | 3-5 |\n\n## Validation\n- [ ] ~50 cases with stories\n- [ ] Mix of change types\n- [ ] Both repos represented","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T21:34:09.963734-08:00","updated_at":"2025-12-27T07:57:48.380297-08:00","closed_at":"2025-12-27T07:57:48.380297-08:00","close_reason":"Implemented classify command and generated eval-dataset.jsonl with 56 classified cases","dependencies":[{"issue_id":"diffview-cq1","depends_on_id":"diffview-sbj","type":"blocks","created_at":"2025-12-26T21:34:22.847171-08:00","created_by":"daemon"},{"issue_id":"diffview-cq1","depends_on_id":"diffview-e3h","type":"blocks","created_at":"2025-12-26T21:34:22.881364-08:00","created_by":"daemon"}]}
{"id":"diffview-d72","title":"Rewrite difflib with zero-allocation tokenizer and LCS algorithm","description":"## Problem\n\nCurrent difflib implementation has ~166 allocations per line pair, mostly from:\n- **pmezard/go-difflib** (~55%): General-purpose LCS algorithm with heavy internal allocations\n- **Regex tokenization** (~35%): regexp.FindAllString creates many intermediate slices\n\nFor diffs with many lines, this adds up. The go-difflib library is also unmaintained.\n\n## Solution\n\nReplace both the tokenizer and diff algorithm with hand-written, allocation-efficient implementations optimized for our use case (short token sequences, typically \u003c50 tokens per line).\n\n### Phase 1: Hand-written tokenizer\nReplace regex with a simple scanner. Expected: ~35% allocation reduction.\n\n### Phase 2: Simple LCS algorithm\nReplace go-difflib with O(n×m) dynamic programming using pre-allocated buffers. For short sequences this is fast enough and nearly allocation-free. Expected: ~55% allocation reduction.\n\n## Entrypoints\n- difflib/difflib.go\n\n## Target\n- From ~166 allocs/op to ~10-20 allocs/op (output segments only)\n- Remove pmezard/go-difflib dependency\n\n## Validation\n- [ ] Benchmarks show significant allocation reduction\n- [ ] All existing tests pass (behavior unchanged)\n- [ ] pmezard/go-difflib removed from go.mod\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T09:39:01.520459-08:00","updated_at":"2025-12-26T09:59:20.678181-08:00","closed_at":"2025-12-26T09:59:20.678181-08:00","close_reason":"Closed"}
{"id":"diffview-dft","title":"Add critique text input to evalreview","description":"## Problem\nEvalreview has pass/fail buttons but no way to write critiques. `ModeCritique` exists but only handles Esc key.\n\nHamel's methodology requires detailed critiques: \"detailed enough for a new employee to understand.\"\n\n## Entrypoints\n- bubbletea/eval.go\n\n## Changes\n1. Add textarea component for critique input\n2. Wire up `[c]` key to enter critique mode\n3. In critique mode:\n   - Show full-screen or expanded textarea\n   - Pre-populate with existing critique if any\n   - `Esc` saves and returns to review mode\n4. Update judgment bar to show critique status (not just truncated text)\n\n## UI Flow\n```\nReview Mode                    Critique Mode\n┌─────────────────────┐       ┌─────────────────────┐\n│ DIFF               │       │ CRITIQUE            │\n│ [diff content]     │       │                     │\n├─────────────────────┤  [c]  │ [textarea with      │\n│ STORY              │ ────► │  existing critique  │\n│ [LLM output]       │       │  or empty]          │\n├─────────────────────┤       │                     │\n│ ○ Pass ● Fail      │ ◄──── │ [Esc] save \u0026 exit   │\n│ Critique: \"...\"    │  Esc  │                     │\n└─────────────────────┘       └─────────────────────┘\n```\n\n## Validation\n- [ ] Can enter critique mode with [c]\n- [ ] Can type multi-line critique\n- [ ] Critique persists to JSONL on save\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T21:33:12.918202-08:00","updated_at":"2025-12-26T22:17:39.666392-08:00","closed_at":"2025-12-26T22:17:39.666392-08:00","close_reason":"Implemented as part of epic diffview-6f7"}
{"id":"diffview-dgu","title":"Fix double line spacing in viewer","description":"## Problem\nThe viewer shows double line spacing between lines. Likely caused by `line.Content` already including trailing newline AND renderer adding another `\\n`.\n\n## Entrypoints\n- `bubbletea/viewer.go:renderDiffWithPositions()` line 172-173\n- Check what go-gitdiff returns in `line.Line`\n\n## Validation\n- [ ] Lines display with normal single spacing\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-23T22:31:56.438468-08:00","updated_at":"2025-12-23T23:11:08.087573-08:00","closed_at":"2025-12-23T23:11:08.087573-08:00","close_reason":"Fixed by trimming trailing newlines from parser content in renderDiffWithPositions","dependencies":[{"issue_id":"diffview-dgu","depends_on_id":"diffview-7u3","type":"blocks","created_at":"2025-12-23T22:32:08.381891-08:00","created_by":"daemon"}]}
{"id":"diffview-dn2","title":"Investigate syntax highlighting for diff content","description":"## Problem\nDiff content is currently displayed with line-level coloring (added/deleted/context) but no syntax highlighting for the actual code. This makes it harder to read and understand code changes, especially for complex diffs.\n\n## Investigation Scope\nThis is a research task to evaluate options before implementation:\n\n### Questions to Answer\n1. **Library options**: What Go libraries exist for syntax highlighting?\n   - chroma (github.com/alecthomas/chroma) - used by Hugo, Goldmark\n   - Others?\n\n2. **Integration approach**: How to layer syntax highlighting with diff styling?\n   - Apply syntax first, then diff background?\n   - Performance implications for large diffs?\n\n3. **Language detection**: How to detect the language for highlighting?\n   - File extension from diff headers\n   - Content-based detection fallback?\n\n4. **Terminal compatibility**: True color vs 256-color vs 16-color\n   - How does chroma handle different terminal capabilities?\n   - Interaction with lipgloss color profiles?\n\n5. **Theme coordination**: How to make syntax colors work with diff backgrounds?\n   - Need syntax themes that look good on green/red/neutral backgrounds\n   - Dark vs light theme considerations\n\n### Deliverables\n- [ ] Document findings in issue notes\n- [ ] Recommend approach with trade-offs\n- [ ] Create implementation tasks if viable\n\n## Context\n- Current diff viewer uses lipgloss for styling\n- Background colors for added/deleted lines already implemented\n- Must handle Unicode correctly (lipgloss.Width)","notes":"## Research Complete\n\nSee docs/syntax-highlighting.md for full findings.\n\n### Key Decisions\n- **Library**: Chroma (github.com/alecthomas/chroma)\n- **Architecture**: Two-pass (syntax foreground → diff background → merge)\n- **Integration**: Extract Chroma tokens into structs, render with Lipgloss (no nested ANSI)\n- **Language detection**: lexers.Match(filename) from diff headers\n- **Theme**: Custom overlay style with no backgrounds\n\n### Trade-offs Considered\n- Partial hunks may break multi-line string/comment highlighting\n- Accept this limitation initially; file-level caching is future optimization\n\n### Implementation Ready\nCreated child tasks for phased implementation.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-24T08:18:49.906619-08:00","updated_at":"2025-12-24T20:16:18.086896-08:00","closed_at":"2025-12-24T20:16:18.086896-08:00","close_reason":"Research complete. Created 5 implementation tasks with dependencies. See docs/syntax-highlighting.md for full findings."}
{"id":"diffview-drc","title":"Styling system","description":"Theme, Styles, ColorPair types. DefaultTheme with diff coloring (added/deleted/context). Light/dark support structure.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-23T18:49:11.761233-08:00","updated_at":"2025-12-23T21:16:58.733579-08:00","closed_at":"2025-12-23T21:16:58.733583-08:00","dependencies":[{"issue_id":"diffview-drc","depends_on_id":"diffview-lzy","type":"parent-child","created_at":"2025-12-23T18:49:42.201597-08:00","created_by":"daemon"},{"issue_id":"diffview-drc","depends_on_id":"diffview-z57","type":"blocks","created_at":"2025-12-23T18:49:53.553227-08:00","created_by":"daemon"}]}
{"id":"diffview-e2w","title":"Add PR-extraction methods to GitRunner","description":"## Problem\nGitRunner lacks methods for extracting PR info from merge commits.\n\n## New Methods\n```go\ntype GitRunner interface {\n    // Existing methods removed, replaced with:\n    MergeCommits(ctx, repoPath string, limit int) ([]string, error)\n    CommitsInRange(ctx, repoPath, base, head string) ([]CommitBrief, error)\n    DiffRange(ctx, repoPath, base, head string) (string, error)\n    CurrentBranch(ctx, repoPath string) (string, error)\n    MergeBase(ctx, repoPath, ref1, ref2 string) (string, error)\n}\n```\n\n## Git Commands\n| Method | Command |\n|--------|---------|\n| MergeCommits | git log --merges --format=%H -n \u003climit\u003e |\n| CommitsInRange | git log --format=%H%x00%s \u003cbase\u003e..\u003chead\u003e |\n| DiffRange | git diff \u003cbase\u003e...\u003chead\u003e |\n| CurrentBranch | git rev-parse --abbrev-ref HEAD |\n| MergeBase | git merge-base \u003cref1\u003e \u003cref2\u003e |\n\n## Files\n- diffview.go (interface)\n- git/runner.go (implementation)\n\n## Validation\n- [ ] All methods implemented with tests\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T11:04:05.693822-08:00","created_by":"filip","updated_at":"2025-12-27T11:43:05.171981-08:00","closed_at":"2025-12-27T11:43:05.171983-08:00","dependencies":[{"issue_id":"diffview-e2w","depends_on_id":"diffview-o5z","type":"blocks","created_at":"2025-12-27T11:04:21.308933-08:00","created_by":"daemon"}]}
{"id":"diffview-e3h","title":"Create classification prompt","description":"## Problem\nNeed a prompt that takes formatted diff + commit message and outputs structured classification.\n\n## Entrypoints\n- gemini/classifier.go (or new package)\n\n## Prompt Requirements\n1. Input: formatted diff (from PromptFormatter)\n2. Output: JSON matching StoryClassification schema\n3. Instructions for:\n   - Hunk categorization (refactoring/systematic/core/noise)\n   - Change type inference (bugfix/feature/refactor/chore/docs)\n   - Narrative pattern selection\n   - Section grouping with explanations\n\n## Output Schema\n```json\n{\n  \"change_type\": \"bugfix|feature|refactor|chore|docs\",\n  \"narrative\": \"cause-effect|core-periphery|before-after|rule-instances|entry-implementation\",\n  \"summary\": \"One sentence\",\n  \"sections\": [\n    {\n      \"role\": \"problem|fix|test|core|supporting|...\",\n      \"title\": \"Section Title\",\n      \"hunks\": [{\"file\": \"...\", \"hunk_index\": 0, \"category\": \"core\", ...}],\n      \"explanation\": \"Why this matters\"\n    }\n  ]\n}\n```\n\n## Validation Rules\n- All input hunks must appear in output\n- Each hunk in exactly one section\n- Valid enum values for all fields\n\n## Notes\n- Start with Gemini (existing integration)\n- Prompt will iterate based on eval results\n\n## Validation\n- [ ] Prompt produces valid JSON\n- [ ] Output validates against schema\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T21:33:45.180986-08:00","updated_at":"2025-12-26T22:17:39.6756-08:00","closed_at":"2025-12-26T22:17:39.6756-08:00","close_reason":"Implemented as part of epic diffview-6f7","dependencies":[{"issue_id":"diffview-e3h","depends_on_id":"diffview-pgd","type":"blocks","created_at":"2025-12-26T21:34:22.813798-08:00","created_by":"daemon"}]}
{"id":"diffview-e72","title":"Verify context cancellation in viewer","description":"## Problem\nContext is passed to `tea.WithContext(ctx)` but we should verify it actually cancels the viewer when the context is cancelled.\n\n## Entrypoints\n- `bubbletea/viewer.go:View()` line 207-218\n- `bubbletea/viewer_test.go:TestViewer_ContextCancellation` - existing test\n\n## Validation\n- [ ] Verify existing test actually tests cancellation properly\n- [ ] Add integration test if needed\n- [ ] make validate passes","notes":"COMPLETED:\n- Reviewed existing TestViewer_ContextCancellation test\n- Enhanced test to verify context.Canceled error is returned\n- Added TestViewer_ContextAlreadyCancelled test for pre-cancelled context edge case\n- make validate passes\n\nFINDINGS:\n- Context cancellation works correctly via tea.WithContext(ctx)\n- Bubble Tea returns context.Canceled when context is cancelled\n- Both runtime cancellation and pre-cancelled context cases work properly","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-23T22:32:02.245551-08:00","updated_at":"2025-12-23T22:54:46.757667-08:00","closed_at":"2025-12-23T22:54:46.757671-08:00"}
{"id":"diffview-eju","title":"Add story domain types, interface, and mock","description":"## Problem\nNeed domain types for representing annotated hunks and story analyses, plus the StoryGenerator interface and its mock.\n\n## Entrypoints\n- Create `story.go` in root package (domain types)\n- Create `generator.go` in root package (interface)\n- Create `mock/generator.go` (mock implementation)\n\n## Implementation\n\n**Types (story.go)**\n- AnnotatedHunk: adds ID to Hunk for LLM reference\n- DiffAnalysis: extensible container with version + analyses array\n- Analysis: type string + json.RawMessage payload\n- StoryAnalysis: change type, summary, parts\n- StoryPart: role, hunk IDs, explanation\n\n**Interface (generator.go)**\n- StoryGenerator with Generate(ctx, hunks) method\n\n**Mock (mock/generator.go)**\n- StoryGenerator with GenerateFn field\n\n## Validation\n- [ ] Types compile with no external dependencies\n- [ ] Interface defined in root package\n- [ ] Mock has compile-time interface verification\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T14:49:39.539515-08:00","updated_at":"2025-12-26T14:58:02.49781-08:00","closed_at":"2025-12-26T14:58:02.49781-08:00","close_reason":"Closed"}
{"id":"diffview-eko","title":"Implement palette-based theme in lipgloss/","description":"## Problem\nlipgloss/ needs to implement Theme using Palette as source of truth.\n\n## Implementation\n1. Create `newTheme(p Palette)` constructor\n2. Implement `stylesFromPalette(p) Styles` generator\n3. Create `DefaultTheme()` with Catppuccin Mocha-inspired palette\n4. Create `TestTheme()` with stable, predictable colors for testing\n5. Remove old DarkTheme/LightTheme if redundant\n6. Move interface compliance check from test to production code\n\n## Entrypoints\n- lipgloss/theme.go\n\n## Testing\n- Verify DefaultTheme().Palette() returns non-empty values\n- Verify TestTheme() has predictable pure colors\n- Verify Styles generated correctly from Palette\n\n## Validation\n- [ ] DefaultTheme() and TestTheme() work\n- [ ] stylesFromPalette generates valid Styles\n- [ ] Old duplicated theme code removed\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T13:53:29.583421-08:00","updated_at":"2025-12-25T14:32:55.804286-08:00","closed_at":"2025-12-25T14:32:55.804286-08:00","close_reason":"Closed","dependencies":[{"issue_id":"diffview-eko","depends_on_id":"diffview-q24","type":"blocks","created_at":"2025-12-25T13:53:41.770889-08:00","created_by":"daemon"}]}
{"id":"diffview-f0y","title":"Parallelize diffstory classify command","description":"## Problem\nThe classify command processes cases sequentially, which is slow for large datasets (96 cases takes several minutes).\n\n## Solution\nAdd worker pool parallelism to the classifier:\n- Add `--workers` flag (default: 4 or 8)\n- Use goroutines with a semaphore/worker pool\n- Collect results and write in order (preserve JSONL ordering)\n\n## Implementation Notes\n- The Gemini API supports concurrent requests\n- Use errgroup for structured concurrency\n- Consider rate limiting to avoid API throttling\n\n## Entrypoints\n- cmd/diffstory/main.go: ClassifyRunner\n\n## Validation\n- [ ] --workers flag accepted\n- [ ] Classification runs N times faster with N workers\n- [ ] Output order preserved (same as input order)\n- [ ] make validate passes","notes":"## WIRING NOTES from diffview-32w\n- The existing ClassifyRunner.classifyWithRetry() handles per-case retry with backoff\n- When parallelizing, call classifyWithRetry() from each worker goroutine\n- Collect results indexed by original position to preserve JSONL ordering\n- The Classifier's timeout is per-call (applied in Classify method via context.WithTimeout), which works correctly with concurrent calls\n- Consider rate limiting via semaphore to avoid overwhelming the API","status":"open","priority":3,"issue_type":"feature","created_at":"2025-12-27T12:55:30.839426-08:00","created_by":"filip","updated_at":"2025-12-27T13:32:42.79567-08:00"}
{"id":"diffview-fob","title":"Update Formatter for PR context section","description":"## Problem\nFormatter produces \u003ccommit_message\u003e section. Need \u003ccontext\u003e with branch and commits.\n\n## Changes\nBefore:\n```\n\u003ccommit_message\u003e\nFix bug in parser\n\u003c/commit_message\u003e\n```\n\nAfter:\n```\n\u003ccontext\u003e\nRepository: diffview\nBranch: diffview-zv1\n\nCommits:\n- af44c89: Address PR feedback\n- 51fad8d: Fix blank lines\n\u003c/context\u003e\n```\n\n## Edge Cases\n- Empty commits list → omit Commits section\n- Single commit → still use new format\n\n## Files\n- format.go\n\n## Validation\n- [ ] New format produces valid output\n- [ ] Empty commits handled\n- [ ] make validate passes","notes":"## Problem\nCurrent DefaultFormatter doesn't include PR context (branch name, commit list) in output.\n\n## Changes\nUpdate Format() to include a context section before the diff:\n```\n## Context\nBranch: feature-branch\nCommits:\n- abc123: Add new feature\n- def456: Fix tests\n```\n\n## WIRING NOTES from diffview-qp5\n- In PR-level mode: Branch is extracted from merge message (e.g., \"Merge pull request #42 from user/feature-branch\" -\u003e \"feature-branch\")\n- In commit-level fallback mode: Branch is empty string (\"\"), Commits has exactly 1 element\n- ParseBranchFromMergeMessage() in cmd/diffstory/main.go shows the extraction logic if edge cases are found\n\n## EDGE CASE\nWhen Branch is empty, the Formatter should still produce valid output (single-commit format or omit Branch line)\n\n## Validation\n- [ ] Context section appears before diff\n- [ ] Branch name displayed when present\n- [ ] Commits listed with hash and message\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T11:04:07.771973-08:00","created_by":"filip","updated_at":"2025-12-27T12:26:47.365755-08:00","closed_at":"2025-12-27T12:26:47.365758-08:00","dependencies":[{"issue_id":"diffview-fob","depends_on_id":"diffview-o5z","type":"blocks","created_at":"2025-12-27T11:04:21.360565-08:00","created_by":"daemon"}]}
{"id":"diffview-fx0","title":"Use diff renderer in evalreview","description":"## Problem\nThe evalreview diff panel renders diffs as plain text with:\n1. Extra blank lines between diff lines (spacing bug)\n2. No syntax highlighting or colors\n3. No word-level diff highlighting\n\nThe codebase already has a sophisticated diff renderer (lipgloss/, chroma/) used by diffview.\n\n## Investigation Needed\n1. Fix the extra newline spacing in current renderer\n2. Evaluate reusing existing diff rendering from diffview:\n   - lipgloss/renderer.go - styled diff rendering\n   - chroma/ - syntax highlighting\n   - worddiff/ - word-level diff highlighting\n3. Determine if these can be integrated into bubbletea/eval.go\n\n## Entrypoints\n- bubbletea/eval.go:updateViewportContent() - current plain rendering\n- lipgloss/renderer.go - existing styled renderer\n- cmd/diffview/ - how diffview wires up rendering\n\n## Validation\n- [ ] No extra blank lines between diff lines\n- [ ] Syntax highlighting works\n- [ ] Added/removed lines have color indicators","notes":"Performance baseline from diffview-ohe: existing lipgloss/chroma rendering handles 7.6MB+ diffs efficiently (~50ms). The issue is visual quality (spacing, highlighting), not performance. Benchmarks in bubbletea/large_diff_test.go available for regression testing.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-27T09:27:34.473673-08:00","updated_at":"2025-12-27T13:49:07.807854-08:00"}
{"id":"diffview-gkp","title":"Add CLI flag to select theme","description":"## Problem\nNo way to select a theme at runtime. Users must use whatever theme is compiled as default.\n\n## Solution\nAdd a `--theme` flag to select from available themes:\n```bash\ngit diff | diffview --theme=colorblind\ngit diff | diffview --theme=high-contrast\ngit diff | diffview --theme=light\ngit diff | diffview --theme=dark  # default\n```\n\n## Implementation\n1. Add theme registry mapping names to theme constructors\n2. Add --theme flag in cmd/diffview/main.go\n3. Pass selected theme to bubbletea.NewModelWithStyles()\n4. Consider auto-detection of light/dark terminal background\n\n## Entrypoints\n- cmd/diffview/main.go (add flag parsing)\n- lipgloss/theme.go (add theme registry/lookup)\n\n## Dependencies\nShould come after colorblind and high-contrast themes exist.\n\n## Validation\n- [ ] --theme flag accepted\n- [ ] Invalid theme names produce helpful error\n- [ ] Each registered theme can be selected\n- [ ] Default remains dark theme\n- [ ] make validate passes","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-23T23:55:40.550811-08:00","updated_at":"2025-12-24T15:14:14.53044-08:00","closed_at":"2025-12-24T15:14:14.53044-08:00","close_reason":"Dependencies closed. Theme flag infrastructure still valuable - will recreate when new visual direction has themes to switch between.","dependencies":[{"issue_id":"diffview-gkp","depends_on_id":"diffview-51z","type":"blocks","created_at":"2025-12-23T23:55:48.220677-08:00","created_by":"daemon"},{"issue_id":"diffview-gkp","depends_on_id":"diffview-99k","type":"blocks","created_at":"2025-12-23T23:55:48.2993-08:00","created_by":"daemon"}]}
{"id":"diffview-hel","title":"Refactor width handling for cleaner testing","description":"## Problem\nCurrent width handling requires sending WindowSizeMsg before positions are computed, making tests awkward:\n```go\nm := bubbletea.NewModel(diff)\nupdated, _ := m.Update(tea.WindowSizeMsg{Width: 80, Height: 24})\nm = updated.(bubbletea.Model)\n```\n\nThis is a hack - the abstraction should make testing easy and logical.\n\n## Solution\nDesign the Model so that:\n- Positions can be accessed without requiring WindowSizeMsg first\n- Width-dependent rendering is cleanly separated from position tracking\n- Tests don't need special setup to verify positions\n\n## Options to explore\n1. Separate position computation from rendering (positions don't depend on width)\n2. Lazy computation with sensible defaults\n3. Builder pattern that makes dependencies explicit\n\n## Entrypoints\n- bubbletea/viewer.go: Model struct, NewModel, renderDiffWithPositions\n\n## Validation\n- [ ] Tests can check positions without WindowSizeMsg hack\n- [ ] Width-based rendering still works correctly\n- [ ] make validate passes","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-24T11:26:12.540892-08:00","updated_at":"2025-12-24T11:39:20.012594-08:00","closed_at":"2025-12-24T11:39:20.012601-08:00"}
{"id":"diffview-icx","title":"Add visual separators between files","description":"## Problem\nIn multi-file diffs, files blend together. Hard to see where one file ends and another begins when scrolling quickly.\n\n## Solution\nAdd visual breathing room between files:\n```\n────────────────────────────────────\n--- a/pkg/foo.go\n+++ b/pkg/foo.go\n```\n\n## Implementation\n- Add separator line before each file header (except first)\n- Use box-drawing character ─ repeated to terminal width\n- Or use lipgloss border on file header block\n- Muted color so it doesn't compete with content\n\n## Entrypoints\n- bubbletea/viewer.go:232-241 (file header rendering)\n\n## Validation\n- [ ] Visual separator appears between files\n- [ ] No separator before first file\n- [ ] Separator spans reasonable width\n- [ ] Styling is subtle/muted\n- [ ] make validate passes","notes":"COMPLETED: Added visual separators between files\n- Added FileSeparator to diffview.Styles struct\n- Updated lipgloss/theme.go for DarkTheme and LightTheme\n- Updated bubbletea/viewer.go default styles\n- Implemented separator rendering in renderDiffWithPositions\n- Separator uses box-drawing character ─ (U+2500) at 80 chars width\n- No separator before first file\n- Updated position tracking tests to account for separator line\n\nVALIDATION: make validate passes","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-23T23:51:20.870131-08:00","updated_at":"2025-12-24T11:08:54.166069-08:00","closed_at":"2025-12-24T11:08:54.166076-08:00"}
{"id":"diffview-iik","title":"Wire theme in cmd/diffview/main.go","description":"## Problem\nmain.go needs to pass theme to viewer.\n\n## Implementation\n1. Import lipgloss package\n2. Pass `lipgloss.DefaultTheme()` to `bubbletea.NewViewer()`\n3. (Future: add flag for theme selection)\n\n## Entrypoints\n- cmd/diffview/main.go\n\n## Testing\n- Manual verification: run diffview and confirm colors work\n\n## Validation\n- [ ] Viewer receives theme\n- [ ] Colors display correctly in terminal\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T13:53:30.27969-08:00","updated_at":"2025-12-25T16:20:25.869539-08:00","closed_at":"2025-12-25T16:20:25.869539-08:00","close_reason":"Closed","dependencies":[{"issue_id":"diffview-iik","depends_on_id":"diffview-8k9","type":"blocks","created_at":"2025-12-25T13:53:42.125011-08:00","created_by":"daemon"}]}
{"id":"diffview-imr","title":"Integrate syntax highlighting with diff line rendering","description":"## Problem\nConnect syntax highlighting to the diff rendering pipeline.\n\n## Implementation\nModify line rendering to use two-pass architecture:\n1. Strip diff prefix (+/-/space)\n2. Tokenize content with chroma\n3. Extract StyledSegment structs with foreground colors\n4. Render each segment with Lipgloss, applying diff background\n\n```go\ntype StyledSegment struct {\n    Text       string\n    Foreground lipgloss.Color\n    Bold       bool\n}\n\nfunc renderLine(prefix string, tokens []StyledSegment, bg lipgloss.Color) string {\n    // Render prefix with diff style\n    // Render each token with syntax fg + diff bg\n}\n```\n\n## Entrypoints\n- Look at current line rendering code in the TUI\n\n## Validation\n- [ ] Syntax colors appear on diff lines\n- [ ] Diff backgrounds still visible\n- [ ] No ANSI bleeding between lines\n- [ ] make validate passes","notes":"## Wiring Requirements\n\nBefore implementing syntax rendering, wire the dependencies into bubbletea.Viewer:\n\n1. Add LanguageDetector field to Viewer struct\n2. Add WithLanguageDetector ViewerOption  \n3. Wire chroma.NewDetector() in cmd/diffview/main.go\n4. Pass detector to Model so renderDiff() can access it\n\nSame pattern needed for Tokenizer (from diffview-tsg).\n\n## Theme Wiring Pattern (from diffview-iik)\n\nFollow the established pattern:\n- Theme is a required constructor param: `NewViewer(theme, opts...)`\n- Access palette in rendering: `palette := theme.Palette()`\n- Syntax colors available: `palette.Keyword`, `palette.String`, etc.\n- Tests use `dv.TestTheme()` for stable colors","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T20:16:02.166785-08:00","updated_at":"2025-12-25T16:50:22.22768-08:00","closed_at":"2025-12-25T16:50:22.227689-08:00","dependencies":[{"issue_id":"diffview-imr","depends_on_id":"diffview-tsg","type":"blocks","created_at":"2025-12-24T20:16:09.454505-08:00","created_by":"daemon"},{"issue_id":"diffview-imr","depends_on_id":"diffview-578","type":"blocks","created_at":"2025-12-24T20:16:09.546441-08:00","created_by":"daemon"},{"issue_id":"diffview-imr","depends_on_id":"diffview-0ti","type":"blocks","created_at":"2025-12-24T20:16:09.634877-08:00","created_by":"daemon"},{"issue_id":"diffview-imr","depends_on_id":"diffview-iik","type":"blocks","created_at":"2025-12-25T13:53:42.213047-08:00","created_by":"daemon"}]}
{"id":"diffview-jec","title":"Generate PR-level eval dataset","description":"## Problem\nNeed new eval dataset with PR-level granularity from both repos.\n\n## Steps\n1. Run collector on diffview repo\n2. Run collector on locdoc repo  \n3. Merge outputs\n4. Run classifier on merged dataset\n5. Validate output structure\n\n## Commands\n```bash\ndiffstory collect --limit=50 . \u003e diffview-prs.jsonl\ndiffstory collect --limit=50 ../locdoc \u003e locdoc-prs.jsonl\ncat diffview-prs.jsonl locdoc-prs.jsonl \u003e all-prs.jsonl\ndiffstory classify all-prs.jsonl \u003e eval-dataset.jsonl\n```\n\n## Expected Output\n- ~20-30 PRs total (vs 56 commits before)\n- Each with branch name and commit list\n- Classified with story\n\n## Validation\n- [ ] Dataset has PR-level cases\n- [ ] Both repos represented\n- [ ] Stories successfully generated","notes":"## Problem\nNeed to regenerate the eval dataset using PR-level extraction.\n\n## Steps\n1. Run `diffstory collect` on target repos\n2. Run `diffstory classify` on collected cases\n3. Validate output format\n\n## WIRING NOTES from diffview-qp5\n- --max-lines default is now 2000 (increased for PRs vs previous 500 for commits)\n- Collector will produce PR-level cases when merge commits exist, commit-level otherwise\n- Branch field extraction works for GitHub merge commit format: \"Merge pull request #N from user/branch-name\"\n- If a repo uses squash merges or direct commits to main, output will be commit-level (each commit = 1 case)\n- Non-GitHub merge formats (e.g., \"Merge branch 'feature' into main\") will return empty branch\n\n## WIRING NOTES from diffview-fob\n- Formatter now outputs \u003ccontext\u003e section instead of \u003ccommit_message\u003e\n- Format:\n  \u003ccontext\u003e\n  Repository: reponame\n  Branch: branchname       (omitted when empty)\n  \n  Commits:                 (section omitted when empty)\n  - hash: Subject line\n  \u003c/context\u003e\n- Branch line omitted in commit-level fallback mode (empty string from collector)\n- Commit messages are subject line only (%s format from git) - multiline not an issue\n\n## Validation\n- [ ] Dataset generated with PR-level cases\n- [ ] Cases include branch and multiple commits\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T11:04:08.80554-08:00","created_by":"filip","updated_at":"2025-12-27T13:20:43.230755-08:00","closed_at":"2025-12-27T13:20:43.230755-08:00","close_reason":"Closed","dependencies":[{"issue_id":"diffview-jec","depends_on_id":"diffview-qp5","type":"blocks","created_at":"2025-12-27T11:04:21.386251-08:00","created_by":"daemon"},{"issue_id":"diffview-jec","depends_on_id":"diffview-fob","type":"blocks","created_at":"2025-12-27T11:04:21.411443-08:00","created_by":"daemon"}]}
{"id":"diffview-jhn","title":"Story-guided review mode for evalreview","description":"## Vision\nUse the classification output to *drive* the review experience, not just display it as metadata. The story becomes navigation, not just description.\n\n## Current State\n- Two panels: raw diff scroll + story text\n- Story shows sections but doesn't guide navigation\n- Reviewer must mentally map story to diff\n\n## Proposed Experience\n1. **Section-by-section navigation**\n   - Each section is a 'page' in the review\n   - [n]/[N] moves between sections\n   - Header shows: section role, title, explanation\n\n2. **Focused hunk display**\n   - Current section's hunks shown prominently\n   - Other hunks collapsed or dimmed\n   - Context preserved for understanding\n\n3. **Progress tracking**\n   - 'Section 2/5: Core Logic'\n   - Checkmarks for reviewed sections\n   - Overall story completion indicator\n\n4. **Compressed view**\n   - CollapseText for noise/systematic hunks\n   - Expand on demand\n   - Focus reviewer attention on core changes\n\n## UX Flow\n```\nStart review\n  → Show story summary (change type, narrative pattern)\n  → Auto-advance to Section 1\n\nFor each section:\n  → Show section header (role, explanation)\n  → Show section's hunks (use diff renderer)\n  → Reviewer can: approve section, add critique, skip\n\nEnd of sections:\n  → Show summary view\n  → Overall pass/fail judgment\n```\n\n## Technical Approach\n- Reuse bubbletea/viewer.go primitives (renderDiff, syntax highlighting)\n- Add section filtering to show subset of hunks\n- EvalModel gains 'story mode' alongside current 'raw mode'\n\n## Dependencies\n- Requires diffview-a2m (section-aware rendering primitives)\n\n## Validation\n- [ ] Can navigate section-by-section through story\n- [ ] Current section's hunks highlighted/focused\n- [ ] Other hunks collapsed with summary text\n- [ ] Section header shows role and explanation\n- [ ] Can toggle between story mode and raw mode","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-27T10:57:50.805204-08:00","created_by":"filip","updated_at":"2025-12-27T10:57:50.805204-08:00","dependencies":[{"issue_id":"diffview-jhn","depends_on_id":"diffview-a2m","type":"blocks","created_at":"2025-12-27T10:57:55.688035-08:00","created_by":"daemon"}]}
{"id":"diffview-lzy","title":"Milestone 1: Diff Pager","description":"A competent git diff | diffview pager with proper domain types, parsing, and navigation. Foundation for future semantic/AI features.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-23T18:48:52.458455-08:00","updated_at":"2025-12-23T22:58:56.11045-08:00","closed_at":"2025-12-23T22:58:56.11045-08:00","close_reason":"All 7 child tasks completed: domain types, parser, viewer scaffold, main wiring, styling system, hunk navigation, keybindings"}
{"id":"diffview-m9i","title":"Hunk navigation","description":"Track hunkPositions during render. Implement n/N (next/prev hunk), ]/[ (next/prev file) jumping.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-23T18:49:12.044884-08:00","updated_at":"2025-12-23T21:59:28.76102-08:00","closed_at":"2025-12-23T21:59:28.761024-08:00","dependencies":[{"issue_id":"diffview-m9i","depends_on_id":"diffview-lzy","type":"parent-child","created_at":"2025-12-23T18:49:42.358068-08:00","created_by":"daemon"},{"issue_id":"diffview-m9i","depends_on_id":"diffview-z57","type":"blocks","created_at":"2025-12-23T18:49:53.712404-08:00","created_by":"daemon"}]}
{"id":"diffview-mle","title":"Investigate PR-level vs commit-level classification","description":"## Problem\nCurrent eval dataset contains individual commits, but work is structured into PRs. This loses context:\n\n- \"Address PR review feedback\" commits are meaningless alone\n- \"Start work\" / \"Close\" commits are workflow noise\n- The PR tells the complete story, commits are chapters\n\n## Findings from Investigation\n- PRs typically have 3-6 commits\n- 56 commits in dataset ≈ 12-18 PRs\n- Git merge commits preserve PR boundaries\n- Squashing would lose granular narrative\n\n## Questions to Answer\n1. Should classification happen at PR level instead of commit level?\n2. Can we classify PRs as a sequence of commits (richer context)?\n3. How to extract PR metadata from git (gh api? merge commits?)\n4. What's the right granularity for the \"story\" we're telling?\n\n## Possible Approaches\n- Keep commit-level but group by PR for review context\n- Classify at PR level, show commit breakdown\n- Hybrid: PR-level summary + commit-level sections\n\n## Entrypoints\n- cmd/diffstory/main.go - current collect command\n- git merge commits contain PR boundaries\n\n## Validation\n- [ ] Decision documented on classification granularity\n- [ ] If changing: update collect command to support PR grouping","notes":"EPIC: PR-level classification implementation\n\nSubtasks (in order):\n1. diffview-o5z: Update ClassificationInput data structures\n2. diffview-e2w: Add PR-extraction methods to GitRunner\n3. diffview-qp5: Rewrite Collector for PR-level extraction\n4. diffview-fob: Update Formatter for PR context section\n5. diffview-jec: Generate PR-level eval dataset\n\nDesign doc: docs/plans/2025-12-27-pr-level-classification-design.md\n\nClose this epic when all subtasks complete.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T09:53:19.068875-08:00","updated_at":"2025-12-27T13:39:08.614688-08:00","closed_at":"2025-12-27T13:39:08.614688-08:00","close_reason":"All 5 subtasks completed and merged: diffview-o5z (data structures), diffview-e2w (GitRunner methods), diffview-qp5 (Collector rewrite), diffview-fob (Formatter update), diffview-jec (dataset generation). PR-level classification is now implemented."}
{"id":"diffview-n5y","title":"Migrate imports from worddiff to difflib","description":"## Task\nUpdate all callers to use the new difflib package instead of worddiff.\n\n## Entrypoints\n- cmd/diffview/main.go\n- bubbletea/viewer.go\n- bubbletea/viewer_test.go\n\n## Implementation\n1. Update imports: worddiff → difflib\n2. Update constructor calls: worddiff.NewDiffer() → difflib.NewDiffer()\n3. Verify all tests pass with new implementation\n\n## Validation\n- [ ] No references to worddiff package remain (except worddiff/ directory itself)\n- [ ] go test ./... passes\n- [ ] make validate passes","notes":"The difflib.Differ is a drop-in replacement for worddiff.Differ:\n- Same constructor pattern: NewDiffer() returns *Differ\n- Same interface: diffview.WordDiffer\n- Same method signature: Diff(old, new string) (oldSegs, newSegs []Segment)\n\nKey behavioral difference: difflib uses token-based diffing (whole identifiers) vs worddiff's character-based diffing (partial words). This is the intended improvement - no code changes needed beyond import swaps.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T00:07:21.110008-08:00","updated_at":"2025-12-26T09:31:56.084654-08:00","closed_at":"2025-12-26T09:31:56.084654-08:00","close_reason":"Closed","dependencies":[{"issue_id":"diffview-n5y","depends_on_id":"diffview-c9g","type":"blocks","created_at":"2025-12-26T00:07:29.794362-08:00","created_by":"daemon"}]}
{"id":"diffview-ni2","title":"Add classification domain types","description":"## Problem\nNeed domain types for diff classification that work at runtime, not just for data collection.\n\n## Entrypoints\n- diffview.go (add new types)\n\n## Types to Add\n```go\ntype CommitInfo struct {\n    Hash    string\n    Repo    string\n    Message string\n}\n\ntype ClassificationInput struct {\n    Commit CommitInfo\n    Diff   Diff\n}\n\ntype StoryClassification struct {\n    ChangeType string    `json:\"change_type\"`\n    Narrative  string    `json:\"narrative\"`\n    Summary    string    `json:\"summary\"`\n    Sections   []Section `json:\"sections\"`\n}\n\ntype Section struct {\n    Role        string    `json:\"role\"`\n    Title       string    `json:\"title\"`\n    Hunks       []HunkRef `json:\"hunks\"`\n    Explanation string    `json:\"explanation\"`\n}\n\ntype HunkRef struct {\n    File         string `json:\"file\"`\n    HunkIndex    int    `json:\"hunk_index\"`\n    Category     string `json:\"category\"`\n    Collapsed    bool   `json:\"collapsed\"`\n    CollapseText string `json:\"collapse_text,omitempty\"`\n}\n\ntype StoryClassifier interface {\n    Classify(ctx context.Context, input ClassificationInput) (*StoryClassification, error)\n}\n```\n\n## Notes\n- Replace or extend existing StoryAnalysis/StoryPart types\n- Update EvalCase to use new types\n\n## Validation\n- [ ] Types compile with no external dependencies in root package\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T21:31:17.707612-08:00","updated_at":"2025-12-26T22:17:39.659049-08:00","closed_at":"2025-12-26T22:17:39.659049-08:00","close_reason":"Implemented as part of epic diffview-6f7"}
{"id":"diffview-npu","title":"Domain types","description":"Root package with Diff, Hunk, Line types and Parser, Viewer interfaces. No external dependencies per Ben Johnson pattern.","notes":"COMPLETED: Domain types (Diff, FileDiff, Hunk, Line) and interfaces (Parser, Viewer)\nIN_PROGRESS: Self-review\nNEXT: Code review and finish\nKEY_DECISIONS: Used io/fs.FileMode for file modes, context.Context for Viewer cancellation","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T18:48:57.465717-08:00","updated_at":"2025-12-23T19:33:23.952374-08:00","closed_at":"2025-12-23T19:33:23.952375-08:00","dependencies":[{"issue_id":"diffview-npu","depends_on_id":"diffview-lzy","type":"parent-child","created_at":"2025-12-23T18:49:41.957753-08:00","created_by":"daemon"}]}
{"id":"diffview-o5z","title":"Update ClassificationInput for PR-level","description":"## Problem\nCurrent ClassificationInput has single CommitInfo. Need to support PR-level with multiple commits.\n\n## Changes\n```go\n// Before\ntype ClassificationInput struct {\n    Commit CommitInfo\n    Diff   Diff\n}\n\n// After\ntype ClassificationInput struct {\n    Repo    string        `json:\"repo\"`\n    Branch  string        `json:\"branch\"`\n    Commits []CommitBrief `json:\"commits\"`\n    Diff    Diff          `json:\"diff\"`\n}\n\ntype CommitBrief struct {\n    Hash    string `json:\"hash\"`\n    Message string `json:\"message\"`\n}\n```\n\n## Files\n- classification.go\n\n## Validation\n- [ ] New types compile\n- [ ] make validate passes","notes":"COMPLETED: Updated ClassificationInput for PR-level\n- Replaced CommitInfo with CommitBrief (hash + message only)\n- Changed Commit field to Commits slice\n- Added Repo and Branch fields at PR level\n- Added FirstCommitHash() and FirstCommitMessage() helper methods for migration\n- Updated all usages in format.go, bubbletea/eval.go, cmd/diffstory/main.go\n- Updated all tests (JSON keys now lowercase)\n\nREVIEW_NOTES:\n- Judgment keying by first commit hash is a known limitation, tracked in diffview-w47\n- Branch field not yet populated (for downstream tasks)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T11:04:04.655628-08:00","created_by":"filip","updated_at":"2025-12-27T11:16:39.575504-08:00","closed_at":"2025-12-27T11:16:39.575507-08:00"}
{"id":"diffview-ohe","title":"Support large diffs that exceed GitHub's render limit","description":"## Problem\nGitHub shows 'Diff is too big to render' for files like eval-dataset.jsonl (7.6MB). diffview should handle these gracefully.\n\n## Use Case\n- Reviewing AI-generated code changes that span many files\n- Viewing eval dataset diffs during development\n- Any diff that exceeds GitHub's ~1MB render limit\n\n## Requirements\n1. diffview should render large diffs without crashing\n2. Consider lazy loading / virtualization for very large diffs\n3. Test with files up to 10MB+\n4. Provide feedback on large file loading (progress indicator?)\n\n## Dogfooding\nThis came from PR #53 where eval-dataset.jsonl couldn't be viewed on GitHub.\n\n## Entrypoints\n- bubbletea/viewer.go - current rendering\n- gitdiff/parser.go - parsing large diffs\n\n## Validation\n- [ ] Can view 7.6MB JSONL diff without issues\n- [ ] Memory usage stays reasonable\n- [ ] UI remains responsive during load\n- [ ] make validate passes","notes":"Tests confirm current implementation handles large diffs well (7.6MB in ~50ms, ~23MB memory). No lazy loading or virtualization was needed. Performance tests in bubbletea/large_diff_test.go provide a regression baseline.\n\nTest coverage:\n- TestLargeDiff_ModelCreation: verifies model creation with large diff\n- TestLargeDiff_Parse: verifies parsing 7.25MB diff in \u003c5s\n- TestLargeDiff_RenderAndView: verifies rendering large diff produces output\n- TestLargeDiff_PerformanceBounds: asserts time \u003c2s, memory \u003c200MB for 7.6MB diff\n- Benchmarks for parse, model create, and render","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-27T13:23:03.438608-08:00","created_by":"filip","updated_at":"2025-12-27T13:50:00.24039-08:00","closed_at":"2025-12-27T13:50:00.24039-08:00","close_reason":"Performance tests confirm diffview handles large diffs (7.6MB+) without issues. Existing implementation is already performant (~50ms render, ~23MB memory). No lazy loading or virtualization needed."}
{"id":"diffview-p0s","title":"Human review of classified diffs","description":"## Problem\nNeed human review of 30-50 classified diffs to validate classification quality and build failure taxonomy.\n\n## Prerequisites\n- Evalreview critique input working\n- Eval dataset collected and classified\n\n## Process (Hamel's methodology)\n1. Load dataset: `evalreview eval-dataset.jsonl`\n2. For each case:\n   - Review diff + story\n   - Pass/fail judgment\n   - Write detailed critique (\"detailed enough for new employee\")\n3. Target: 30-50 cases reviewed\n\n## Critique Guidance\nFor failures, explain:\n- Which hunk categories are wrong?\n- Is change type correct?\n- Does narrative pattern fit?\n- Are sections sensibly grouped?\n\nFor passes with issues:\n- Note any minor problems\n- Suggest improvements\n\n## Output\n- judgments JSONL with critiques\n- Ready for axial coding\n\n## Validation\n- [ ] 30+ cases reviewed\n- [ ] Each failure has detailed critique\n- [ ] Critiques exportable for taxonomy","notes":"Waiting for PR-level dataset from diffview-mle. Commit-level dataset was deleted.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-26T21:34:10.107811-08:00","updated_at":"2025-12-27T10:53:39.178297-08:00","dependencies":[{"issue_id":"diffview-p0s","depends_on_id":"diffview-dft","type":"blocks","created_at":"2025-12-26T21:34:22.914446-08:00","created_by":"daemon"},{"issue_id":"diffview-p0s","depends_on_id":"diffview-cq1","type":"blocks","created_at":"2025-12-26T21:34:22.948336-08:00","created_by":"daemon"},{"issue_id":"diffview-p0s","depends_on_id":"diffview-mle","type":"blocks","created_at":"2025-12-27T10:53:39.100003-08:00","created_by":"daemon"},{"issue_id":"diffview-p0s","depends_on_id":"diffview-w47","type":"blocks","created_at":"2025-12-27T10:54:37.596857-08:00","created_by":"daemon"}]}
{"id":"diffview-pgd","title":"Add prompt formatter for classification input","description":"## Problem\nNeed to render `ClassificationInput` as structured text for LLM prompt.\n\n## Entrypoints\n- New file: format.go or classifier.go in root package (interface)\n- Implementation in gemini/ or new llm/ package\n\n## Output Format\n```\n\u003ccommit_message\u003e\nFix authentication token expiry\n\nTokens were not being refreshed properly when they expired.\n\u003c/commit_message\u003e\n\n\u003cdiff\u003e\n=== FILE: pkg/auth/login.go (modified) ===\n\n--- HUNK H1 (@@ -45,6 +45,10 @@) ---\n func (a *Auth) ValidateToken(token string) error {\n+    if a.isExpired(token) {\n+        return ErrTokenExpired\n+    }\n     return a.validator.Validate(token)\n }\n\n--- HUNK H2 (@@ -82,3 +86,7 @@) ---\n[more hunk content]\n\n=== FILE: pkg/auth/login_test.go (added) ===\n...\n\u003c/diff\u003e\n```\n\n## Interface\n```go\ntype PromptFormatter interface {\n    Format(input ClassificationInput) string\n}\n```\n\n## Key Details\n- Hunk IDs use format: H1, H2, H3... (sequential across all files)\n- File headers show operation type: modified/added/deleted/renamed\n- Include @@ line numbers in hunk headers\n\n## Validation\n- [ ] Formatter produces consistent output\n- [ ] All hunks get unique IDs\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T21:33:45.044678-08:00","updated_at":"2025-12-26T22:17:39.672618-08:00","closed_at":"2025-12-26T22:17:39.672618-08:00","close_reason":"Implemented as part of epic diffview-6f7","dependencies":[{"issue_id":"diffview-pgd","depends_on_id":"diffview-ni2","type":"blocks","created_at":"2025-12-26T21:34:22.779362-08:00","created_by":"daemon"}]}
{"id":"diffview-q24","title":"Add Palette type and update Theme interface","description":"## Problem\nRoot package needs Palette type as domain abstraction for colors.\n\n## Implementation\n1. Add `Color` type alias for hex strings\n2. Add `Palette` struct with 18 semantic color fields:\n   - Base: Background, Foreground\n   - Diff: Added, Deleted, Modified, Context\n   - Syntax: Keyword, String, Number, Comment, Operator, Function, Type, Constant, Punctuation\n   - UI: UIBackground, UIForeground, UIAccent\n3. Update `Theme` interface to include `Palette()` method\n\n## Entrypoints\n- styles.go\n\n## Testing\n- Test that Palette fields are defined (data type, no behavior)\n- Verify Theme interface compiles with new method\n\n## Validation\n- [ ] Palette type has all 18 fields\n- [ ] Theme interface includes Palette() method\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T13:53:29.350423-08:00","updated_at":"2025-12-25T14:03:50.531729-08:00","closed_at":"2025-12-25T14:03:50.531729-08:00","close_reason":"Closed"}
{"id":"diffview-qp5","title":"Rewrite Collector for PR-level extraction","description":"## Problem\nCurrent Collector iterates individual commits. Need to iterate merge commits and extract PR-level diffs.\n\n## Changes\nReplace:\n```\nfor each commit hash:\n    git show \u003chash\u003e\n    emit single-commit EvalCase\n```\n\nWith:\n```\nfor each merge commit:\n    parse merge message → branch name\n    commits = git log merge^1..merge^2\n    diff = git diff merge^1...merge^2\n    emit PR-level EvalCase\n```\n\n## Fallback for non-merge workflows\nIf MergeCommits() returns empty (direct commits to main, squash merges, fast-forward merges):\n- Fall back to Log() to get regular commits\n- Each commit becomes its own unit for classification\n- Works well for squash merges (each = 1 PR's work)\n\n## Files\n- cmd/diffstory/main.go (Collector)\n\n## Considerations\n- Bump --max-lines default (PRs are larger)\n- Parse GitHub merge commit format: 'Merge pull request #N from user/branch'\n\n## Validation\n- [ ] Collector produces PR-level cases from merge commits\n- [ ] Falls back to individual commits when no merge commits\n- [ ] Each case has branch + commits list\n- [ ] make validate passes","notes":"COMPLETED: PR-level extraction with fallback\n\n## Implementation Summary\n- Collector.Run() now tries MergeCommits() first, falls back to Log() if empty\n- ParseBranchFromMergeMessage() extracts branch from GitHub merge commit format\n- Non-GitHub merge formats (e.g., \"Merge branch 'feature' into main\") return empty branch\n- --max-lines bumped from 500 to 2000 for larger PR diffs\n\n## Key Files Changed\n- cmd/diffstory/main.go: runPRLevel(), runCommitLevel(), ParseBranchFromMergeMessage()\n- cmd/diffstory/main_test.go: Added tests for PR-level and fallback modes\n\n## Design Decisions\n- GitHub merge format only: Other merge formats return empty branch (acceptable for current use case)\n- ParseBranchFromMergeMessage is exported for testability\n- Existing commit-level tests updated to trigger fallback path","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T11:04:06.742813-08:00","created_by":"filip","updated_at":"2025-12-27T12:10:45.340691-08:00","closed_at":"2025-12-27T12:10:45.340693-08:00","dependencies":[{"issue_id":"diffview-qp5","depends_on_id":"diffview-e2w","type":"blocks","created_at":"2025-12-27T11:04:21.335055-08:00","created_by":"daemon"}]}
{"id":"diffview-s2k","title":"Improve word diff: token-based diffing instead of character-level","description":"## Problem\nCurrent worddiff implementation uses diff-match-patch at character level. This produces partial identifier highlighting (myVariable vs myValue shows myVa as common), which is confusing for code review.\n\n## Solution\nReplace character-level diffing with token-based array diffing using pmezard/go-difflib. Rename package from worddiff/ to difflib/ following Ben Johnson pattern.\n\n## Design\nSee docs/plans/2025-12-26-token-based-word-diff-design.md\n\n## Validation\n- [ ] No partial identifier highlighting\n- [ ] Similarity threshold skips noisy diffs  \n- [ ] Performance acceptable (\u003c100ms per line pair)\n- [ ] make validate passes","notes":"COMPLETED: Design and task breakdown\n- Design document: docs/plans/2025-12-26-token-based-word-diff-design.md\n- Created 6 sub-tasks with dependencies\n\nNEXT: Start with diffview-bua (add go-difflib dependency)","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-25T23:50:41.521751-08:00","updated_at":"2025-12-26T09:35:45.083843-08:00","closed_at":"2025-12-26T09:35:45.083843-08:00","close_reason":"All sub-tasks completed. Token-based diffing implemented with pmezard/go-difflib, benchmarks added, migration complete, old worddiff package removed."}
{"id":"diffview-sbj","title":"Update diffstory collect to use new domain types","description":"## Problem\n`diffstory collect` uses `CollectedCase` which lacks commit message and repo info. Need to use new domain types.\n\n## Entrypoints\n- cmd/diffstory/main.go (Collector struct and CollectedCase)\n\n## Changes\n1. Replace `CollectedCase` with `diffview.EvalCase` using `ClassificationInput`\n2. Call new `Git.Message()` to get commit message\n3. Add `--repo` flag or auto-detect repo name from path\n4. Output format:\n```json\n{\n  \"input\": {\n    \"commit\": {\"hash\": \"abc123\", \"repo\": \"diffview\", \"message\": \"Fix auth bug\"},\n    \"diff\": {...}\n  },\n  \"story\": null\n}\n```\n\n## Filter Criteria (from design)\n- Skip commits with \u003c 5 lines changed\n- Skip commits with \u003e 500 lines changed\n- Add `--min-lines` and `--max-lines` flags\n\n## Validation\n- [ ] Output includes commit message\n- [ ] Output includes repo name\n- [ ] Filtering works\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T21:33:44.91331-08:00","updated_at":"2025-12-26T22:17:39.669642-08:00","closed_at":"2025-12-26T22:17:39.669642-08:00","close_reason":"Implemented as part of epic diffview-6f7","dependencies":[{"issue_id":"diffview-sbj","depends_on_id":"diffview-ni2","type":"blocks","created_at":"2025-12-26T21:34:22.710861-08:00","created_by":"daemon"},{"issue_id":"diffview-sbj","depends_on_id":"diffview-120","type":"blocks","created_at":"2025-12-26T21:34:22.745273-08:00","created_by":"daemon"}]}
{"id":"diffview-sfm","title":"Add gutter symbols for line type indicators","description":"## Problem\nLine type is indicated only by +/- prefix and color. A dedicated gutter column with symbols would create cleaner visual columns.\n\n## Solution\nAdd a gutter column with box-drawing indicators:\n```\n│+│  added line content\n│-│  deleted line content\n│ │  context line content\n```\n\n## Implementation\n- Add gutter column between line numbers (if present) and content\n- Use box-drawing characters for clean lines\n- Color the +/- symbols to match line type\n- Muted border color\n\n## Entrypoints\n- bubbletea/viewer.go:254-268 (line rendering)\n\n## Dependencies\nConsider implementing after line numbers feature for consistent gutter design.\n\n## Validation\n- [ ] Gutter column with │+│, │-│, │ │ indicators\n- [ ] Symbols colored to match line type\n- [ ] Clean vertical alignment\n- [ ] make validate passes","notes":"COMPLETED: Gutter symbol column implementation\n- Added formatSymbolColumn function that renders │+│, │-│, │ │ indicators\n- Removed redundant line prefixes (+/-/space) since symbol column now serves this purpose\n- Modified formatGutter to remove trailing separator (now part of symbol column)\n- Removed linePrefixFor function and prefix parameter from renderLineWithSegments\n- Symbols are colored to match line type (added=green, deleted=red, context=neutral)\n- Box-drawing borders use muted line number style for clean appearance\n\nKEY_DECISIONS:\n- Symbol column format: │symbol│ with borders in line number style, symbol in line type color\n- Removed trailing │ from formatGutter, symbol column provides both separators\n- Line prefixes removed as redundant - gutter symbols are the visual indicators now","status":"closed","priority":4,"issue_type":"feature","created_at":"2025-12-23T23:51:21.521389-08:00","updated_at":"2025-12-24T15:03:24.762829-08:00","closed_at":"2025-12-24T14:55:20.814655-08:00","dependencies":[{"issue_id":"diffview-sfm","depends_on_id":"diffview-svh","type":"blocks","created_at":"2025-12-23T23:51:29.978448-08:00","created_by":"daemon"}]}
{"id":"diffview-svh","title":"Add line numbers in gutter column","description":"## Problem\nNo line numbers shown - users can't reference specific lines or correlate with their editor. Essential for code review workflows.\n\n## Solution\nAdd a gutter column showing old/new line numbers:\n```\n  12    14  │  context line\n  13     -  │- deleted line\n   -    15  │+ added line\n```\n\n## Implementation\n- Track line numbers during rendering (increment from Hunk.OldStart/NewStart)\n- Use lipgloss.JoinHorizontal to compose: lineNumStyle + separator + content\n- Line number style: right-aligned, fixed width, muted color\n- Show '-' for lines that don't exist on that side\n\n## Entrypoints\n- bubbletea/viewer.go:210-277 (renderDiffWithPositions - add gutter rendering)\n- diffview/styles.go (may need LineNumber ColorPair)\n\n## Validation\n- [ ] Old and new line numbers shown in gutter\n- [ ] Numbers increment correctly per line type\n- [ ] Deleted lines show number on left, '-' on right\n- [ ] Added lines show '-' on left, number on right\n- [ ] Context lines show both numbers\n- [ ] Gutter has muted styling, doesn't distract from content\n- [ ] make validate passes","notes":"COMPLETED: Line number gutter implementation\n- Added LineNumber ColorPair to Styles type\n- Added formatGutter and formatLineNum helper functions\n- Modified renderDiffWithPositions to prepend gutter to each line\n- Added tests for line number rendering\n- Dark theme uses #6c7086 (muted gray)\n- Light theme uses #9ca0b0 (lighter muted gray)\n\nIN_PROGRESS: Self-review\n\nKEY_DECISIONS:\n- Gutter width is 4 chars per column (old/new)\n- Format: '   1    2 │+content' with pipe separator\n- Using '-' for missing line numbers (added/deleted lines)","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-23T23:51:20.396538-08:00","updated_at":"2025-12-24T08:54:57.478112-08:00","closed_at":"2025-12-24T08:54:57.478119-08:00"}
{"id":"diffview-szv","title":"Design and implement evalreview TUI","description":"## Problem\nNeed TUI for reviewing LLM-generated diff stories with pass/fail judgments.\n\n## Design Document\nSee `docs/plans/2025-12-26-evalreview-tui-design.md` for full design.\n\n## Implementation Summary\n\n### Architecture (Ben Johnson Layout)\n\n**Root package** (`diffview/`):\n- `evalreview.go` - Domain types: `EvalCase`, `Judgment`, `EvalCaseLoader`, `JudgmentStore` interfaces\n\n**New packages**:\n- `jsonl/loader.go` - Implements `EvalCaseLoader`\n- `jsonl/store.go` - Implements `JudgmentStore`\n\n**Extend existing**:\n- `bubbletea/eval.go` - `EvalModel` (separate from viewer.go)\n- `bubbletea/eval_keymap.go` - Keybindings\n- `mock/eval.go` - Mocks for new interfaces\n\n**CLI**:\n- `cmd/evalreview/main.go` - Entry point\n\n### UI Layout\nVertical stack: diff panel (50%), story panel (35%), judgment bar, status bar.\n\n### Modes\n- **Review mode**: Navigate cases (j/k), scroll panels (d/s + scroll keys), judge (p/f)\n- **Critique mode**: Text input (c to enter, Esc to exit)\n\n### Data Flow\n- Input: `eval/cases/*.jsonl` (EvalCase per line: commit + hunks + story)\n- Output: `*-judgments.jsonl` (separate file, auto-saved)\n\n## Implementation Order\n1. Domain types in `evalreview.go`\n2. JSONL loader/store with tests\n3. EvalModel core (layout, navigation, scrolling)\n4. Judgment capture (p/f, critique, persistence)\n5. CLI entry point\n\n## Validation\n- [ ] `evalreview eval/cases/test.jsonl` launches TUI\n- [ ] Navigate between cases with j/k\n- [ ] Scroll diff/story independently with d/s + scroll keys\n- [ ] Record pass/fail with p/f\n- [ ] Enter/save critique with c/Esc\n- [ ] Judgments persist to `*-judgments.jsonl`\n- [ ] Re-launch loads previous judgments\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-26T14:49:41.655825-08:00","updated_at":"2025-12-26T18:09:20.623714-08:00","closed_at":"2025-12-26T18:09:20.62372-08:00","dependencies":[{"issue_id":"diffview-szv","depends_on_id":"diffview-3zd","type":"blocks","created_at":"2025-12-26T14:49:52.806347-08:00","created_by":"daemon"},{"issue_id":"diffview-szv","depends_on_id":"diffview-41i","type":"blocks","created_at":"2025-12-26T14:49:52.839205-08:00","created_by":"daemon"}]}
{"id":"diffview-t5f","title":"Capture current view as eval case","description":"## Problem\nBuilding eval dataset requires running collect command on historical commits. No way to capture interesting cases encountered during normal review workflow.\n\n## Proposed Solution\nAdd a keybinding (e.g., 'e' for export to eval) that:\n1. Saves current ClassificationInput + StoryClassification to eval JSONL file\n2. Optionally prompts for pass/fail judgment inline\n3. Appends to configured eval dataset path\n\nThis enables dogfooding - building the dataset organically from real usage rather than mining historical commits. Captures the cases users actually care about.\n\n## Entrypoints\n- cmd/diffview or bubbletea UI (wherever the review UI lives)\n\n## Validation\n- [ ] Can capture case from review UI with keybinding\n- [ ] Case appears in eval dataset JSONL\n- [ ] make validate passes","status":"open","priority":3,"issue_type":"feature","created_at":"2025-12-27T11:27:03.831225-08:00","created_by":"filip","updated_at":"2025-12-27T11:27:03.831225-08:00"}
{"id":"diffview-tsg","title":"Add chroma dependency and syntax token extraction","description":"## Problem\nNeed infrastructure for syntax highlighting using chroma library.\n\n## Implementation\n1. Add github.com/alecthomas/chroma/v2 dependency\n2. Create syntax/ package following Ben Johnson pattern\n3. Implement token extraction using iterator API (not quick.Highlight)\n4. Use chroma.Coalesce() wrapper for performance\n\n## Key Code Pattern\n```go\nlexer := lexers.Get(language)\nlexer = chroma.Coalesce(lexer)\niterator, _ := lexer.Tokenise(nil, code)\nfor token := iterator(); token != chroma.EOF; token = iterator() {\n    // extract foreground color, bold, text\n}\n```\n\n## Validation\n- [ ] Token extraction works for Go code\n- [ ] make validate passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T20:16:00.282715-08:00","updated_at":"2025-12-24T21:27:51.467137-08:00","closed_at":"2025-12-24T21:27:51.467142-08:00"}
{"id":"diffview-vqr","title":"Move interface compliance checks from tests to production code","description":"## Problem\nInterface compliance checks (`var _ Interface = (*Type)(nil)`) are incorrectly placed in test files instead of production code. This provides runtime verification only, when we want compile-time guarantees.\n\n## Files to Fix\n1. `gitdiff/parser_test.go:356` → move to `gitdiff/parser.go`\n2. `bubbletea/viewer_test.go:29` → move to `bubbletea/viewer.go`\n3. `lipgloss/theme_test.go:17,90,136` → move to `lipgloss/theme.go` (convert inline checks to package-level)\n4. `chroma/tokenizer_test.go:62` → move to `chroma/tokenizer.go`\n\n## Validation\n- [ ] All interface checks are in production files, not test files\n- [ ] No functional changes - just moving declarations\n- [ ] make validate passes","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-25T13:18:38.449466-08:00","updated_at":"2025-12-25T14:17:34.075341-08:00","closed_at":"2025-12-25T14:17:34.075341-08:00","close_reason":"Closed"}
{"id":"diffview-w0d","title":"Parser implementation","description":"gitdiff/ package using bluekeyes/go-gitdiff. Parses unified diff, flattens file-centric to hunk-centric, computes line numbers.","notes":"COMPLETED: Parser implementation with go-gitdiff\n- Created gitdiff/ package with Parser type\n- Implements diffview.Parser interface\n- Parses unified diff format, handles all file operations (add/delete/modify/rename/copy)\n- Computes line numbers for old and new files\n- Handles binary files, no-newline-at-EOF markers\n- 8 passing tests covering all major scenarios\n\nKEY_DECISIONS:\n- Package named 'gitdiff' after the dependency (Ben Johnson pattern)\n- go-gitdiff strips a/b prefixes from paths (library behavior, not added back)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T18:49:11.479258-08:00","updated_at":"2025-12-23T20:18:47.669586-08:00","closed_at":"2025-12-23T20:18:47.669589-08:00","dependencies":[{"issue_id":"diffview-w0d","depends_on_id":"diffview-lzy","type":"parent-child","created_at":"2025-12-23T18:49:42.042751-08:00","created_by":"daemon"},{"issue_id":"diffview-w0d","depends_on_id":"diffview-npu","type":"blocks","created_at":"2025-12-23T18:49:53.383597-08:00","created_by":"daemon"}]}
{"id":"diffview-w47","title":"Update Judgment keying for PR-level classification","description":"## Problem\nThe Judgment type uses `Commit string` as the key to link judgments to EvalCases. With PR-level classification, there's no single commit hash - we have a branch name and multiple commits.\n\n## Current\n```go\ntype Judgment struct {\n    Commit   string    `json:\"commit\"`    // Links to EvalCase.Input.Commit.Hash\n    Index    int       `json:\"index\"`\n    ...\n}\n```\n\nKeyed by: `c.Input.Commit.Hash`\n\n## Proposed\n```go\ntype Judgment struct {\n    CaseID   string    `json:\"case_id\"`   // Unique identifier for EvalCase\n    Index    int       `json:\"index\"`\n    ...\n}\n```\n\nKeyed by: `fmt.Sprintf(\"%s/%s\", c.Input.Repo, c.Input.Branch)`\n\n## Affected Files\n- evalreview.go - Judgment type\n- bubbletea/eval.go - Uses Commit field for judgment lookup\n- jsonl/store.go - May need updates\n\n## Validation\n- [ ] Judgments correctly link to PR-level cases\n- [ ] Existing evalreview UI works with new keying\n- [ ] make validate passes","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T10:54:32.51455-08:00","created_by":"filip","updated_at":"2025-12-27T10:54:32.51455-08:00","dependencies":[{"issue_id":"diffview-w47","depends_on_id":"diffview-mle","type":"blocks","created_at":"2025-12-27T10:54:37.556635-08:00","created_by":"daemon"}]}
{"id":"diffview-xjy","title":"Enhance file headers with change statistics","description":"## Problem\nFile headers only show path. No quick way to see how much changed in each file without reading through all hunks.\n\n## Solution\nEnhanced file header showing change stats:\n```\n── pkg/service/handler.go ─────────────────── +15 -8 ──\n```\n\n## Implementation\n- Count added/deleted lines per file from hunks\n- Format header with path + stats\n- Use full-width styling with box-drawing characters\n- Bold or more prominent styling than current\n\n## Entrypoints\n- bubbletea/viewer.go:232-241 (file header rendering)\n- May need helper to count changes from []Hunk\n\n## Validation\n- [ ] File headers show +N -M change counts\n- [ ] Counts are accurate per file\n- [ ] Header styling is prominent but not overwhelming\n- [ ] Works with file separators feature\n- [ ] make validate passes","notes":"COMPLETED: FileDiff.Stats() method, enhanced file header rendering\nIN_PROGRESS: Self-review\nKEY_DECISIONS: Stats appended to +++ line as '+N -M' format","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-23T23:51:21.091989-08:00","updated_at":"2025-12-24T12:12:47.533261-08:00","closed_at":"2025-12-24T12:12:47.533265-08:00"}
{"id":"diffview-xtn","title":"Keybindings","description":"KeyMap type, DefaultKeyMap with vim-style navigation. Multi-key sequence handling (gg) via pendingKey state.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-23T18:49:11.903201-08:00","updated_at":"2025-12-23T21:36:02.98577-08:00","closed_at":"2025-12-23T21:36:02.985775-08:00","dependencies":[{"issue_id":"diffview-xtn","depends_on_id":"diffview-lzy","type":"parent-child","created_at":"2025-12-23T18:49:42.27919-08:00","created_by":"daemon"},{"issue_id":"diffview-xtn","depends_on_id":"diffview-z57","type":"blocks","created_at":"2025-12-23T18:49:53.633992-08:00","created_by":"daemon"}]}
{"id":"diffview-yj1","title":"Create diffstory CLI with analyze command","description":"## Problem\nNeed CLI entry point that wires gemini/ and reads diffs from stdin or file.\n\n## Entrypoints\n- Create `cmd/diffstory/main.go`\n\n## Usage\n```bash\ndiffstory analyze \u003c diff.patch\ndiffstory analyze path/to/diff.patch\n```\n\n## Implementation\n- Wire Parser (gitdiff) + Generator (gemini)\n- Parse diff → annotate hunks with IDs → generate story → output JSON\n- Handle both stdin and file argument\n\n## Validation\n- [ ] Can read diff from stdin\n- [ ] Can read diff from file argument\n- [ ] Outputs valid JSON to stdout\n- [ ] make validate passes","notes":"## Wiring Notes from diffview-56j\n\n### Using the gemini Package\n\n1. **Client creation**: Use `gemini.NewClient(ctx, apiKey)` where apiKey comes from environment or config. Example:\n   ```go\n   apiKey := os.Getenv(\"GEMINI_API_KEY\")\n   client, err := gemini.NewClient(ctx, apiKey)\n   ```\n\n2. **Generator creation**: Use `gemini.NewGenerator(client, gemini.DefaultModel)` - the constant is `gemini-3-flash-preview`.\n\n3. **Generator implements diffview.StoryGenerator**: The Generator already has the compile-time check and correctly returns `*diffview.DiffAnalysis`.\n\n4. **Client lifecycle**: Call `client.Close()` when done (currently a no-op but good practice for forward compatibility).\n\n### Annotating Hunks\n\nThe CLI is responsible for creating `[]diffview.AnnotatedHunk` from parsed hunks. Per issue notes from diffview-eju:\n- File path is NOT in AnnotatedHunk - encode file context in the ID string if needed for prompt construction\n- The ID must be unique so the LLM response can reference specific hunks\n\n### Example Wiring Pattern\n\n```go\napiKey := os.Getenv(\"GEMINI_API_KEY\")\nif apiKey == \"\" {\n    return fmt.Errorf(\"GEMINI_API_KEY environment variable required\")\n}\n\nctx := context.Background()\nclient, err := gemini.NewClient(ctx, apiKey)\nif err != nil { return err }\ndefer client.Close()\n\ngen := gemini.NewGenerator(client, gemini.DefaultModel)\n\nresult, err := gen.Generate(ctx, annotatedHunks)\n```\n\n### Error Handling\n\nThe generator surfaces API errors directly - handle rate limits and authentication errors appropriately.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T14:49:40.326118-08:00","updated_at":"2025-12-26T16:18:02.372679-08:00","closed_at":"2025-12-26T16:18:02.372687-08:00","dependencies":[{"issue_id":"diffview-yj1","depends_on_id":"diffview-56j","type":"blocks","created_at":"2025-12-26T14:49:52.739674-08:00","created_by":"daemon"}]}
{"id":"diffview-ypm","title":"Build failure taxonomy from critiques","description":"## Problem\nNeed to group critiques into failure categories (axial coding) to guide prompt iteration.\n\n## Prerequisites\n- 30+ reviewed cases with critiques\n\n## Process\n1. Export critiques to markdown\n2. Use LLM to propose groupings:\n   ```\n   Here are critiques from reviewing an LLM diff classifier.\n   Group them into a failure taxonomy - distinct categories of errors.\n   ```\n3. Review and refine taxonomy\n4. Map each failure to categories\n5. Count frequency per category\n\n## Expected Categories (examples)\n- Wrong hunk category (e.g., core labeled as noise)\n- Wrong change type\n- Poor section grouping\n- Missing narrative coherence\n- Incorrect collapse decisions\n\n## Output\n- Failure taxonomy document\n- Frequency counts\n- Priority order for prompt fixes\n\n## Validation\n- [ ] Taxonomy covers all failures\n- [ ] Categories are distinct and actionable\n- [ ] Clear priority for iteration","notes":"UPSTREAM NOTES (from diffview-zv1):\n- Critique export functionality was deferred from diffview-zv1 as 'Nice to Have'\n- Consider creating a small task for `evalreview export` command before starting taxonomy work\n- Alternatively, extract critiques manually from eval-dataset-judgments.jsonl using jq:\n  `jq -r 'select(.critique \\!= \"\") | \"## \\(.commit)\\n\\(.critique)\\n\"' eval-dataset-judgments.jsonl \u003e critiques.md`","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-26T21:34:10.245808-08:00","updated_at":"2025-12-27T09:17:27.084144-08:00","dependencies":[{"issue_id":"diffview-ypm","depends_on_id":"diffview-p0s","type":"blocks","created_at":"2025-12-26T21:34:22.983566-08:00","created_by":"daemon"}]}
{"id":"diffview-z57","title":"Viewer scaffold","description":"bubbletea/ package with basic Model, viewport integration, stdin reading, quit handling. Minimal working pager.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T18:49:11.622236-08:00","updated_at":"2025-12-23T20:33:37.027674-08:00","closed_at":"2025-12-23T20:33:37.027676-08:00","dependencies":[{"issue_id":"diffview-z57","depends_on_id":"diffview-lzy","type":"parent-child","created_at":"2025-12-23T18:49:42.12409-08:00","created_by":"daemon"},{"issue_id":"diffview-z57","depends_on_id":"diffview-npu","type":"blocks","created_at":"2025-12-23T18:49:53.469895-08:00","created_by":"daemon"}]}
{"id":"diffview-z85","title":"Add GitHub-style theme matching familiar diff colors","description":"## Problem\nMany developers are accustomed to GitHub's diff colors. Offering a familiar option reduces cognitive switching.\n\n## Solution\nAdd a theme matching GitHub's diff color scheme:\n- Added: green text on light green background\n- Deleted: red text on light red/pink background\n- Familiar to most developers\n\n## Implementation\nExtract colors from GitHub's CSS or use approximations:\n```go\nfunc GithubDarkTheme() *Theme {\n    return \u0026Theme{\n        styles: diffview.Styles{\n            Added: diffview.ColorPair{\n                Foreground: \"#3fb950\", // GitHub green\n                Background: \"#1b4721\", // Dark green bg\n            },\n            Deleted: diffview.ColorPair{\n                Foreground: \"#f85149\", // GitHub red\n                Background: \"#5d1a1a\", // Dark red bg\n            },\n            // ...\n        },\n    }\n}\n```\n\n## Entrypoints\n- lipgloss/theme.go\n\n## Validation\n- [ ] GithubDarkTheme() exists\n- [ ] Colors reasonably match GitHub's diff view\n- [ ] make validate passes","status":"closed","priority":4,"issue_type":"feature","created_at":"2025-12-23T23:55:40.771208-08:00","updated_at":"2025-12-24T15:14:09.25337-08:00","closed_at":"2025-12-24T15:14:09.25337-08:00","close_reason":"Pausing: visual direction shifting from full-background colors to gutter-mark-based minimal UI. Will revisit accessibility themes once new primitives are in place."}
{"id":"diffview-zv1","title":"Add navigation helpers to evalreview","description":"## Problem\nFor efficient error analysis, reviewers need quick navigation to unjudged cases and ability to filter.\n\n## Entrypoints\n- bubbletea/eval.go\n\n## Changes\n1. `[u]` - jump to next unjudged case\n2. `[U]` - jump to previous unjudged case\n3. Show full critique in story panel when case is selected (not truncated)\n4. Visual indicator in status: unjudged (○) / pass (✓) / fail (✗) / has-critique (●)\n\n## Nice to Have (future task)\n- Filter view: show only failures\n- Export critiques to markdown\n\n## Validation\n- [ ] [u] jumps to next unjudged\n- [ ] Status shows clear judgment state\n- [ ] make validate passes","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-26T21:33:13.056781-08:00","updated_at":"2025-12-27T09:19:06.407275-08:00","closed_at":"2025-12-27T09:19:06.40728-08:00","dependencies":[{"issue_id":"diffview-zv1","depends_on_id":"diffview-dft","type":"blocks","created_at":"2025-12-26T21:34:22.677343-08:00","created_by":"daemon"}]}
